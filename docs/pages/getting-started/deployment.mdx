import { Callout } from "nextra/components"
import { Accordion, Accordions } from "@/components/Accordion"

# 部署

## 环境变量

<Callout>
  为了保持一致性，我们建议所有 Auth.js 环境变量都以 `AUTH_`
  作为前缀。这样我们可以更好地自动检测它们，也能更轻松地区分于其他环境变量。
</Callout>

Auth.js 库要求您设置 `AUTH_SECRET` 环境变量，该变量用于加密 cookies 和令牌。它应当是一个至少 32 个字符的加密安全随机字符串：

```bash npm2yarn
npm exec auth secret
```

如果您使用 [OAuth 提供商](/concepts/oauth)，您的提供商将为您提供 **Client ID** 和 **Client Secret**，您也需要将它们设置为环境变量（对于 OIDC 提供商，如 Auth0，可能还需要第三个 `issuer` 值，请参阅提供商的特定文档）。

<Callout type="info">
Auth.js 支持 **环境变量推断**，这意味着如果您按照特定语法命名您的提供商环境变量，您无需在配置中显式传递给提供商。

Client ID 和 client secret 应命名为 `AUTH_[PROVIDER]_ID` 和 `AUTH_[PROVIDER]_SECRET`。如果您的提供商需要 issuer，则应命名为 `AUTH_[PROVIDER]_ISSUER`。例如：

```bash
AUTH_OKTA_ID=abc
AUTH_OKTA_SECRET=abc
AUTH_OKTA_ISSUER=abc
```

更多信息，请查看我们的 [环境变量](/guides/environment-variables) 页面。

</Callout>

### `AUTH_SECRET`

这是唯一严格必需的环境变量。它用于编码 JWT 和在传输过程中加密数据的密钥。如前所述，我们建议至少使用 32 个字符的随机字符串。可以通过 CLI 命令 `npm exec auth secret` 生成，或使用 openssl 命令 `openssl rand -base64 33` 生成。

### `AUTH_TRUST_HOST`

当您的应用程序部署在反向代理后方时，需要将 `AUTH_TRUST_HOST` 设置为 `true`。这会告知 Auth.js 信任来自反向代理的 `X-Forwarded-Host` 标头。如果检测到环境变量表明您的应用程序运行在受支持的托管提供商上，Auth.js 会自动推断该值为 true。目前支持 `VERCEL` 和 `CF_PAGES`（Cloudflare Pages）。

### `AUTH_URL`

在 v5 版本中这个环境变量大多情况下不需要，因为主机地址会从请求头中自动推断。但如果您使用不同的基础路径，也可以设置此环境变量。例如：`AUTH_URL=http://localhost:3000/web/auth` 或 `AUTH_URL=https://company.com/app1/auth`

### `AUTH_REDIRECT_PROXY_URL`

> **_NOTE:_** 部分提供商（例如 Apple）不支持使用[重定向代理](https://github.com/nextauthjs/next-auth/blob/3ec06842682a31e53fceabca701a362abda1e7dd/packages/core/src/lib/utils/providers.ts#L48)。

此环境变量仅设计用于高级使用场景，例如将 Auth.js 作为预览部署的代理时。更多详情请参阅下方的[保护预览部署](#securing-a-preview-deployment)章节。

## 无服务器部署

1. 为所需环境创建必要的[环境变量](#environment-variables)。别忘了同时添加所选提供商要求的必备环境变量（例如 OAuth 的 `clientId`/`clientSecret` 等）。
2. 使用 OAuth 提供商时，请确保生产环境的回调 URL 配置正确。许多 OAuth 提供商每个应用仅允许设置一个 `callbackUrl`。这种情况下，您需要为每个环境（开发、生产等）创建独立的应用。而 Google 等其他提供商则允许在一个应用中添加多个 `callbackUrl`。
   - 默认情况下，`next-auth`（Next.js）应用的回调 URL 应形如：`https://company.com/api/auth/callback/[provider]`（将 `company.com` 替换为您的域名，`provider` 替换为提供商名称，如 `github`）。
   - 其他框架（`@auth/sveltekit`、`@auth/express` 等）默认使用路径 `/auth/callback/[provider]`。
3. 开始部署！完成上述两项前提条件后，您应该能够在 Netlify、Vercel 等平台上部署并运行 Auth.js 应用。

<Callout type="warning">
  如果您将用户存储在[数据库](/getting-started/database)中，我们建议为开发/生产环境使用不同的
  OAuth 应用，以避免测试用户与生产用户数据混杂。
</Callout>

## 可观测性

要将当前用户的详细信息传递至可观测性工具，您可以使用 Auth.js 提供的回调函数。例如，在 `session` 回调中，可以将 `user.id` 传递给 Sentry。

```ts filename="auth.ts"
import * as Sentry from "@sentry/browser"
import NextAuth from "next-auth"

export const { handlers, auth, signIn, signOut } = NextAuth({
  callbacks: {
    session({ session, user }) {
      const scope = Sentry.getCurrentScope()

      scope.setUser({
        id: user.id,
        email: user.email,
      })

      return session
    },
  },
})
```

## 自托管部署

Auth.js 可以部署在任何支持您所选框架的环境中。请查阅对应框架关于自托管的文档说明。

### Docker 支持

在 Docker 环境中，请确保在 Auth.js 配置中设置 `trustHost: true` 或将 `AUTH_TRUST_HOST` 环境变量设为 `true`。

我们的示例应用也通过 Docker 托管在[此处](https://nextjs-docker-example.authjs.dev)（查看[源代码](https://github.com/nextauthjs/next-auth-example)）。以下是一个使用 Auth.js 的 Next.js 应用的示例 `Dockerfile`。

```docker filename="Dockerfile"
# syntax=docker/dockerfile:1
FROM node:20-alpine AS base

# Install dependencies only when needed
FROM base AS deps
# Check https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine to understand why libc6-compat might be needed.
RUN apk add --no-cache libc6-compat
WORKDIR /app

# Install dependencies
COPY package.json pnpm-lock.yaml* ./
RUN corepack enable pnpm && pnpm i --frozen-lockfile

# Rebuild the source code only when needed
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Next.js collects completely anonymous telemetry data about general usage.
# Learn more here: https://nextjs.org/telemetry
# Uncomment the following line in case you want to disable telemetry during the build.
# ENV NEXT_TELEMETRY_DISABLED 1

RUN corepack enable pnpm && pnpm build

# Production image, copy all the files and run next
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production
# Uncomment the following line in case you want to disable telemetry during runtime.
# ENV NEXT_TELEMETRY_DISABLED 1

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public

# Set the correct permission for prerender cache
RUN mkdir .next
RUN chown nextjs:nodejs .next

# Automatically leverage output traces to reduce image size
# https://nextjs.org/docs/advanced-features/output-file-tracing
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

# server.js is created by next build from the standalone output
# https://nextjs.org/docs/pages/api-reference/next-config-js/output
CMD ["node", "server.js"]
```

## 保护预览部署环境

> **_NOTE:_** 部分提供商（例如 Apple）不支持[重定向代理](https://github.com/nextauthjs/next-auth/blob/3ec06842682a31e53fceabca701a362abda1e7dd/packages/core/src/lib/utils/providers.ts#L48)功能。

大多数 OAuth 提供商不支持配置多个回调 URL 或使用通配符。

然而，Auth.js **支持预览部署**，甚至**兼容大多数 OAuth 提供商**。其核心思路是通过一个固定部署来代理认证请求，将其转发至主应用动态生成的 URL。例如，您可以维护一个稳定的部署（如 `auth.company.com`），将所有 OAuth 提供商的 `callbackUrl` 指向该地址。认证成功后，该应用会将用户重定向回预览部署的 URL（如 `https://git-abc123-myapp.vercel.app`）。按照以下步骤即可为预览部署配置 Auth.js 安全认证：

1. 确定一个稳定的部署 URL。例如选择构建后不会变更的部署地址，如 `auth.yourdomain.com`（使用子域名并非强制要求，主站点 URL 同样适用）
2. 在**预览环境和稳定环境**中，将 `AUTH_REDIRECT_PROXY_URL` 设置为该稳定部署 URL，需包含 Auth.js 处理路由的路径。例如：(`https://auth.yourdomain.com/api/auth`)。若稳定环境中未设置该变量，代理功能将无法启用！
3. 更新 OAuth 提供商配置中的 `callbackUrl` 为稳定部署 URL。以 GitHub 为例，应设置为 `https://auth.yourdomain.com/api/auth/callback/github`。

冷知识：我们所有的示例应用都在使用代理功能！

<Callout type="info">
  为了支持预览部署，`AUTH_SECRET` 值必须在稳定部署和需要 OAuth
  支持的部署之间保持一致。
</Callout>

<details>
<summary>
<b>这是如何工作的？</b>
</summary>
为了支持预览部署，Auth.js 需要一个在多次部署间保持稳定的部署 URL 作为重定向代理服务器。

只有当设置了 `AUTH_REDIRECT_PROXY_URL` 环境变量时，它才会将 OAuth 回调请求重定向到预览部署 URL。

当用户在预览部署上发起 OAuth 登录流程时，我们会将其 URL 保存在 `state` 查询参数中，但将 `redirect_uri` 设置为稳定部署的 URL。

然后，OAuth 提供商会将用户重定向到上述稳定 URL，该 URL 会验证 `state` 参数，并在 `state` 有效时将用户重定向到预览部署 URL。这是通过依赖稳定部署和预览部署使用相同的服务器端 `AUTH_SECRET` 来确保安全的。

</details>
