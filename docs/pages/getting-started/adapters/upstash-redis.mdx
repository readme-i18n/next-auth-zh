import { Code } from "@/components/Code"

<img
  align="right"
  src="/img/adapters/upstash-redis.svg"
  width="64"
  height="64"
/>

# Upstash Redis 适配器

## 相关资源

- [Upstash 文档](https://docs.upstash.com/redis)

## 配置

### 安装

```bash npm2yarn
npm install @upstash/redis @auth/upstash-redis-adapter
```

### 环境变量

```sh
UPSTASH_REDIS_URL,
UPSTASH_REDIS_TOKEN
```

### 配置

<Code>
<Code.Next>

```ts filename="./auth.ts"
import NextAuth from "next-auth"
import { UpstashRedisAdapter } from "@auth/upstash-redis-adapter"
import { Redis } from "@upstash/redis"

const redis = new Redis({
  url: process.env.UPSTASH_REDIS_URL!,
  token: process.env.UPSTASH_REDIS_TOKEN!,
})

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: UpstashRedisAdapter(redis),
  providers: [],
})
```

</Code.Next>
<Code.Qwik>

```ts filename="/src/routes/plugin@auth.ts"
import { QwikAuth$ } from "@auth/qwik"
import { UpstashRedisAdapter } from "@auth/upstash-redis-adapter"
import { Redis } from "@upstash/redis"

const redis = new Redis({
  url: import.meta.env.UPSTASH_REDIS_URL!,
  token: import.meta.env.UPSTASH_REDIS_TOKEN!,
})

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    providers: [],
    adapter: UpstashRedisAdapter(redis),
  })
)
```

</Code.Qwik>
<Code.Svelte>

```ts filename="./src/auth.ts"
import { SvelteKitAuth } from "@auth/sveltekit"
import { UpstashRedisAdapter } from "@auth/upstash-redis-adapter"
import { Redis } from "@upstash/redis"

const redis = new Redis({
  url: process.env.UPSTASH_REDIS_URL!,
  token: process.env.UPSTASH_REDIS_TOKEN!,
})

export const { handle, signIn, signOut } = SvelteKitAuth({
  adapter: UpstashRedisAdapter(redis),
  providers: [],
})
```

</Code.Svelte>
<Code.Express>

```ts filename="./src/routes/auth.route.ts"
import { ExpressAuth } from "@auth/express"
import { UpstashRedisAdapter } from "@auth/upstash-redis-adapter"
import { Redis } from "@upstash/redis"

const redis = new Redis({
  url: process.env.UPSTASH_REDIS_URL!,
  token: process.env.UPSTASH_REDIS_TOKEN!,
})

const app = express()

app.set("trust proxy", true)
app.use(
  "/auth/*",
  ExpressAuth({
    providers: [],
    adapter: UpstashRedisAdapter(redis),
  })
)
```

</Code.Express>
</Code>

### 高级用法

#### 在单个 Upstash Redis 实例上运行多个应用

Upstash 免费版仅允许创建一个 Redis 实例。如果多个 Auth.js 连接的应用共用该实例，需要为每个应用设置不同的键前缀。

可通过向适配器工厂函数传入第二个参数 `options` 对象来修改前缀。

该对象的默认值为：

```ts
const defaultOptions = {
  baseKeyPrefix: "",
  accountKeyPrefix: "user:account:",
  accountByUserIdPrefix: "user:account:by-user-id:",
  emailKeyPrefix: "user:email:",
  sessionKeyPrefix: "user:session:",
  sessionByUserIdKeyPrefix: "user:session:by-user-id:",
  userKeyPrefix: "user:",
  verificationTokenKeyPrefix: "user:token:",
}
```

通常在此场景下只需修改 `baseKeyPrefix` 即可，但对于更复杂的自定义配置，也可以单独修改每个键的前缀。

```ts
export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: UpstashRedisAdapter(redis, { baseKeyPrefix: "app2:" }),
})
```
