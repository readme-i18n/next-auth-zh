import { Callout } from "nextra/components"
import { Code } from "@/components/Code"

<img align="right" src="/img/adapters/d1.svg" width="64" height="64" />

# Cloudflare D1 适配器

## 相关资源

- [Cloudflare D1 文档](https://developers.cloudflare.com/d1/)

## 配置

### 安装

```bash npm2yarn
npm install next-auth @auth/d1-adapter
```

### 环境变量

在 Cloudflare 平台中，环境变量可通过 [`wrangler.toml`](https://developers.cloudflare.com/workers/wrangler/configuration/#environment-variables) 配置文件或[管理面板](https://dash.cloudflare.com/?to=/:account/pages/view/:pages-project/settings/environment-variables)进行设置。

### 配置

<Code>
<Code.Next>

```ts filename="./auth.ts"
import NextAuth from "next-auth"
import { D1Adapter } from "@auth/d1-adapter"

export const { handlers, auth, signIn, signOut } = NextAuth({
  providers: [],
  adapter: D1Adapter(env.db),
})
```

</Code.Next>
<Code.Qwik>

```ts filename="/src/routes/plugin@auth.ts"
import { QwikAuth$ } from "@auth/qwik"
import { D1Adapter } from "@auth/d1-adapter"

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    providers: [],
    adapter: D1Adapter(env.db),
  })
)
```

</Code.Qwik>
<Code.Svelte>

```ts filename="./src/auth.ts"
import { SvelteKitAuth } from "@auth/sveltekit"
import { D1Adapter } from "@auth/d1-adapter"

export const { handle, signIn, signOut } = SvelteKitAuth({
  providers: [],
  adapter: D1Adapter(env.db),
})
```

</Code.Svelte>
<Code.Express>

```ts filename="./src/routes/auth.route.ts"
import { ExpressAuth } from "@auth/express"
import { D1Adapter } from "@auth/d1-adapter"

const app = express()

app.set("trust proxy", true)
app.use(
  "/auth/*",
  ExpressAuth({
    providers: [],
    adapter: D1Adapter(env.db),
  })
)
```

</Code.Express>
</Code>

### 数据迁移

在应用初始化阶段，您需要执行 `up(env.db)` 函数以在 D1 中创建数据表。若以下表不存在，该操作将创建 4 张表：
`accounts`、`sessions`、`users` 和 `verification_tokens`。

当前表前缀 `""` 不可配置。

您可以使用如下方式，在每次 Worker 启动时尝试执行迁移。重复运行迁移不会清除已有数据表。

```javascript
import { up } from "@auth/d1-adapter"

let migrated = false
async function migrationHandle({ event, resolve }) {
  if (!migrated) {
    try {
      await up(event.platform.env.db)
      migrated = true
    } catch (e) {
      console.log(e.cause.message, e.message)
    }
  }
  return resolve(event)
}
```

- 您也可以手动初始化数据表。请查阅 [migrations.ts](https://github.com/nextauthjs/next-auth/blob/main/packages/adapter-d1/src/migrations.ts) 获取相关 SQL 语句及上述 `up()` 函数示例。
- 在 [Cloudflare 控制台](https://dash.cloudflare.com/?to=/:account/workers/d1)的 D1 数据库界面中粘贴并执行这些 SQL 语句。
