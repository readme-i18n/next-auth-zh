import { Callout } from "nextra/components"
import { Code } from "@/components/Code"

<img align="right" src="/img/adapters/pouchdb.svg" width="64" height="64" />

# PouchDB 适配器

## 相关资源

- [PouchDB 文档](https://pouchdb.com/api.html)

## 配置

### 安装

```bash npm2yarn
npm install pouchdb pouchdb-find @auth/pouchdb-adapter
```

### 配置

<Code>
<Code.Next>

```ts filename="./auth.ts"
import NextAuth from "next-auth"
import { PouchDBAdapter } from "@auth/pouchdb-adapter"
import PouchDB from "pouchdb"

// Setup your PouchDB instance and database
PouchDB.plugin(require("pouchdb-adapter-leveldb")) // Or any other adapter
  .plugin(require("pouchdb-find")) // Don't forget the `pouchdb-find` plugin

const pouchdb = new PouchDB("auth_db", { adapter: "leveldb" })

export const { handlers, auth, signIn, signOut } = NextAuth({
  providers: [],
  adapter: PouchDBAdapter(pouchdb),
})
```

</Code.Next>
<Code.Qwik>

```ts filename="/src/routes/plugin@auth.ts"
import { QwikAuth$ } from "@auth/qwik"
import { PouchDBAdapter } from "@auth/pouchdb-adapter"
import PouchDB from "pouchdb"

// Setup your PouchDB instance and database
PouchDB.plugin(require("pouchdb-adapter-leveldb")) // Or any other adapter
  .plugin(require("pouchdb-find")) // Don't forget the `pouchdb-find` plugin

const pouchdb = new PouchDB("auth_db", { adapter: "leveldb" })

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    providers: [],
    adapter: PouchDBAdapter(pouchdb),
  })
)
```

</Code.Qwik>
<Code.Svelte>

```ts filename="./auth.ts"
import { SvelteKitAuth } from "@auth/sveltekit"
import { PouchDBAdapter } from "@auth/pouchdb-adapter"
import PouchDB from "pouchdb"

// Setup your PouchDB instance and database
PouchDB.plugin(require("pouchdb-adapter-leveldb")) // Or any other adapter
  .plugin(require("pouchdb-find")) // Don't forget the `pouchdb-find` plugin

const pouchdb = new PouchDB("auth_db", { adapter: "leveldb" })

export const { handle, signIn, signOut } = SvelteKitAuth({
  providers: [],
  adapter: PouchDBAdapter(pouchdb),
})
```

</Code.Svelte>
<Code.Express>

```ts filename="./src/routes/auth.route.ts"
import { ExpressAuth } from "@auth/express"
import { PouchDBAdapter } from "@auth/pouchdb-adapter"
import PouchDB from "pouchdb"

// Setup your PouchDB instance and database
PouchDB.plugin(require("pouchdb-adapter-leveldb")) // Or any other adapter
  .plugin(require("pouchdb-find")) // Don't forget the `pouchdb-find` plugin

const pouchdb = new PouchDB("auth_db", { adapter: "leveldb" })

const app = express()

app.set("trust proxy", true)
app.use(
  "/auth/*",
  ExpressAuth({
    providers: [],
    adapter: PouchDBAdapter(pouchdb),
  })
)
```

</Code.Express>
</Code>

<Callout>
  根据您的架构设计，可以使用 PouchDB 的 http 适配器连接任何兼容 CouchDB
  协议的数据库（CouchDB、Cloudant 等），或使用其他 PouchDB
  兼容适配器（leveldb、内存数据库等）
</Callout>

<Callout type="info">
  您的 PouchDB 实例必须安装 `pouchdb-find`
  插件，因为适配器内部会使用该插件来构建和管理索引
</Callout>

### 高级用法

#### 内存优先缓存策略

如需提升认证层性能，可利用 PouchDB 强大的同步功能和多种适配器构建内存优先缓存策略。

使用内存型 PouchDB 作为主认证数据库，并与任何持久化 PouchDB 保持同步。可在启动时从持久化 PouchDB 到内存 PouchDB 执行单向一次性复制，随后建立双向持续同步。

在无服务器环境中，由于并发性、函数启动时间增加等原因，此方案可能不会显著提升性能。

更多细节请参阅 https://pouchdb.com/api.html#sync
