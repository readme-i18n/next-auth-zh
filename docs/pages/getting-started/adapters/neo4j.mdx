import { Code } from "@/components/Code"

<img align="right" src="/img/adapters/neo4j.svg" height="64" width="128" />

# Neo4j 适配器

## 相关资源

- [Neo4j 文档](https://neo4j.com/docs/)

## 配置

### 安装

```bash npm2yarn
npm install @auth/neo4j-adapter neo4j-driver
```

### 环境变量

```sh
NEO4J_URI=bolt://localhost
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=abc
```

### 配置

<Code>
<Code.Next>

```ts filename="./auth.ts"
import NextAuth from "next-auth"
import neo4j from "neo4j-driver"
import { Neo4jAdapter } from "@auth/neo4j-adapter"

const driver = neo4j.driver(
  process.env.NEO4J_URI,
  neo4j.auth.basic(process.env.NEO4J_USERNAME, process.env.NEO4J_PASSWORD)
)

const neo4jSession = driver.session()

export const { handlers, auth, signIn, signOut } = NextAuth({
  providers: [],
  adapter: Neo4jAdapter(neo4jSession),
})
```

</Code.Next>
<Code.Qwik>

```ts filename="/src/routes/plugin@auth.ts"
import { QwikAuth$ } from "@auth/qwik"
import neo4j from "neo4j-driver"
import { Neo4jAdapter } from "@auth/neo4j-adapter"

const driver = neo4j.driver(
  import.meta.env.NEO4J_URI,
  neo4j.auth.basic(
    import.meta.env.NEO4J_USERNAME,
    import.meta.env.NEO4J_PASSWORD
  )
)

const neo4jSession = driver.session()

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    providers: [],
    adapter: Neo4jAdapter(neo4jSession),
  })
)
```

</Code.Qwik>
<Code.Svelte>

```ts filename="./src/auth.ts"
import { SvelteKitAuth } from "@auth/sveltekit"
import neo4j from "neo4j-driver"
import { Neo4jAdapter } from "@auth/neo4j-adapter"

const driver = neo4j.driver(
  process.env.NEO4J_URI,
  neo4j.auth.basic(process.env.NEO4J_USERNAME, process.env.NEO4J_PASSWORD)
)

const neo4jSession = driver.session()

export const { handle, signIn, signOut } = SvelteKitAuth({
  providers: [],
  adapter: Neo4jAdapter(neo4jSession),
})
```

</Code.Svelte>
<Code.Express>

```ts filename="./src/routes/auth.route.ts"
import { ExpressAuth } from "@auth/express"
import neo4j from "neo4j-driver"
import { Neo4jAdapter } from "@auth/neo4j-adapter"

const app = express()

const driver = neo4j.driver(
  process.env.NEO4J_URI,
  neo4j.auth.basic(process.env.NEO4J_USERNAME, process.env.NEO4J_PASSWORD)
)

const neo4jSession = driver.session()

app.set("trust proxy", true)
app.use(
  "/auth/*",
  ExpressAuth({
    providers: [],
    adapter: Neo4jAdapter(neo4jSession),
  })
)
```

</Code.Express>
</Code>

### 数据库模式

#### 节点标签

使用以下节点标签。

- User
- Account
- Session
- VerificationToken

#### 关系

使用以下关系及关系标签。

- `(:User)-[:HAS_ACCOUNT]->(:Account)`
- `(:User)-[:HAS_SESSION]->(:Session)`

#### 属性

此模式已适配用于 Neo4j，基于我们的核心[模型](https://authjs.dev/reference/core/adapters#models)。节点属性请参考该文档。关系不包含属性。

#### 索引

最优索引方案会因您使用的 Neo4j 版本（社区版或企业版）以及节点上是否附加自定义数据而有所不同。以下是基础建议索引方案。

1. 为**社区版和企业版**同时创建约束和索引

```sql
CREATE CONSTRAINT user_id_constraint IF NOT EXISTS
ON (u:User) ASSERT u.id IS UNIQUE;

CREATE INDEX user_id_index IF NOT EXISTS
FOR (u:User) ON (u.id);

CREATE INDEX user_email_index IF NOT EXISTS
FOR (u:User) ON (u.email);

CREATE CONSTRAINT session_session_token_constraint IF NOT EXISTS
ON (s:Session) ASSERT s.sessionToken IS UNIQUE;

CREATE INDEX session_session_token_index IF NOT EXISTS
FOR (s:Session) ON (s.sessionToken);
```

2a. **仅社区版**需创建单属性索引

```sql
CREATE INDEX account_provider_index IF NOT EXISTS
FOR (a:Account) ON (a.provider);

CREATE INDEX account_provider_account_id_index IF NOT EXISTS
FOR (a:Account) ON (a.providerAccountId);

CREATE INDEX verification_token_identifier_index IF NOT EXISTS
FOR (v:VerificationToken) ON (v.identifier);

CREATE INDEX verification_token_token_index IF NOT EXISTS
FOR (v:VerificationToken) ON (v.token);
```

2b. **仅企业版**需创建复合节点键约束和索引

```sql
CREATE CONSTRAINT account_provider_composite_constraint IF NOT EXISTS
ON (a:Account) ASSERT (a.provider, a.providerAccountId) IS NODE KEY;

CREATE INDEX account_provider_composite_index IF NOT EXISTS
FOR (a:Account) ON (a.provider, a.providerAccountId);

CREATE CONSTRAINT verification_token_composite_constraint IF NOT EXISTS
ON (v:VerificationToken) ASSERT (v.identifier, v.token) IS NODE KEY;

CREATE INDEX verification_token_composite_index IF NOT EXISTS
FOR (v:VerificationToken) ON (v.identifier, v.token);
```
