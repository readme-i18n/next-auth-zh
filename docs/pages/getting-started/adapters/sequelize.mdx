import { Callout } from "nextra/components"
import { Code } from "@/components/Code"

<img align="right" src="/img/adapters/sequelize.svg" height="64" width="64" />

# Sequelize 适配器

## 相关资源

- [Sequelize 文档](https://sequelize.org/docs/v6/getting-started/)
- [连接数据库](https://sequelize.org/master/manual/getting-started.html#connecting-to-a-database)

## 配置

### 安装

```bash npm2yarn
npm install @auth/sequelize-adapter sequelize
```

### 环境变量

```sh
DATABASE_URL=postgres://postgres:adminadmin@0.0.0.0:5432/db
```

### 配置

<Callout type="warning">
  您还需要手动安装[所选数据库的驱动程序](https://sequelize.org/master/manual/getting-started.html)。
</Callout>

<Code>
<Code.Next>

```ts filename="./auth.ts"
import NextAuth from "next-auth"
import SequelizeAdapter from "@auth/sequelize-adapter"
import { Sequelize } from "sequelize"

const sequelize = new Sequelize(process.env.DATABASE_URL)

export const { handlers, auth, signIn, signOut } = NextAuth({
  providers: [],
  adapter: SequelizeAdapter(sequelize),
})
```

</Code.Next>
<Code.Qwik>

```ts filename="/src/routes/plugin@auth.ts"
import { QwikAuth$ } from "@auth/qwik"
import SequelizeAdapter from "@auth/sequelize-adapter"
import { Sequelize } from "sequelize"

const sequelize = new Sequelize(import.meta.env.DATABASE_URL)

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    providers: [],
    adapter: SequelizeAdapter(sequelize),
  })
)
```

</Code.Qwik>
<Code.Svelte>

```ts filename="./src/auth.ts"
import { SvelteKitAuth } from "@auth/sveltekit"
import SequelizeAdapter from "@auth/sequelize-adapter"
import { Sequelize } from "sequelize"

const sequelize = new Sequelize(process.env.DATABASE_URL)

export const { handle, signIn, signOut } = SvelteKitAuth({
  providers: [],
  adapter: SequelizeAdapter(sequelize),
})
```

</Code.Svelte>
<Code.Express>

```ts filename="./src/routes/auth.route.ts"
import { ExpressAuth } from "@auth/express"
import SequelizeAdapter from "@auth/sequelize-adapter"
import { Sequelize } from "sequelize"

const sequelize = new Sequelize(process.env.DATABASE_URL)

const app = express()

app.set("trust proxy", true)
app.use(
  "/auth/*",
  ExpressAuth({
    providers: [],
    adapter: SequelizeAdapter(sequelize),
  })
)
```

</Code.Express>
</Code>

### 数据库模式

默认情况下，sequelize 适配器不会在数据库中创建表。在生产环境中，最佳实践是通过[迁移](https://sequelize.org/master/manual/migrations.html)在数据库中创建[所需的表](/concepts/database-models)。在开发环境中，您可以调用 [`sequelize.sync()`](https://sequelize.org/master/manual/model-basics.html#model-synchronization) 让 sequelize 自动创建必要的表、外键和索引：

> 此模式已适配 Sequelize 使用，并基于我们的主[模式](/concepts/database-models)

```ts filename="./auth.ts"
import NextAuth from "next-auth"
import SequelizeAdapter from "@auth/sequelize-adapter"
import Sequelize from "sequelize"

const sequelize = new Sequelize("sqlite::memory:")
const adapter = SequelizeAdapter(sequelize)

// Calling sync() is not recommended in production
sequelize.sync()

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter,
})
```

## 高级用法

### 使用自定义模型

Sequelize 模型可按如下方式进行自定义：

```ts filename="./auth.ts"
import NextAuth from "next-auth"
import SequelizeAdapter, { models } from "@auth/sequelize-adapter"
import Sequelize, { DataTypes } from "sequelize"

const sequelize = new Sequelize("sqlite::memory:")

export const { handlers, auth, signIn, signOut } = NextAuth({
  // https://authjs.dev/reference/providers/
  providers: [],
  adapter: SequelizeAdapter(sequelize, {
    models: {
      User: sequelize.define("user", {
        ...models.User,
        phoneNumber: DataTypes.STRING,
      }),
    },
  }),
})
```
