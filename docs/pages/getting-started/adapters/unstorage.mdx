import { Code } from "@/components/Code"

<img align="right" src="/img/adapters/unstorage.svg" width="64" height="64" />

# Unstorage 适配器

## 相关资源

- [Unstorage 文档](https://unstorage.unjs.io/)

## 配置

### 安装

```bash npm2yarn
npm install unstorage @auth/unstorage-adapter
```

### 配置

<Code>
<Code.Next>

```ts filename="./auth.ts"
import NextAuth from "next-auth"
import { UnstorageAdapter } from "@auth/unstorage-adapter"
import { createStorage } from "unstorage"

const storage = createStorage()

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: UnstorageAdapter(storage),
  providers: [],
})
```

</Code.Next>
<Code.Qwik>

```ts filename="/src/routes/plugin@auth.ts"
import { QwikAuth$ } from "@auth/qwik"
import { UnstorageAdapter } from "@auth/unstorage-adapter"
import { createStorage } from "unstorage"

const storage = createStorage()

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    providers: [],
    adapter: UnstorageAdapter(storage),
  })
)
```

</Code.Qwik>
<Code.Svelte>

```ts filename="./src/auth.ts"
import { SvelteKitAuth } from "@auth/sveltekit"
import { UnstorageAdapter } from "@auth/unstorage-adapter"
import { createStorage } from "unstorage"

const storage = createStorage()

export const { handle, signIn, signOut } = SvelteKitAuth({
  adapter: UnstorageAdapter(storage),
  providers: [],
})
```

</Code.Svelte>
<Code.Express>

```ts filename="./src/routes/auth.route.ts"
import { ExpressAuth } from "@auth/express"
import { UnstorageAdapter } from "@auth/unstorage-adapter"
import { createStorage } from "unstorage"

const storage = createStorage()

const app = express()

app.set("trust proxy", true)
app.use(
  "/auth/*",
  ExpressAuth({
    providers: [],
    adapter: UnstorageAdapter(storage),
  })
)
```

</Code.Express>
</Code>

### 高级用法

#### 多个应用共享同一存储

如果多个 Auth.js 关联应用使用相同的存储，需要为每个应用设置不同的键前缀。

可以通过向适配器工厂函数传递第二个参数 `options` 对象来修改前缀。

该对象的默认值为：

```ts
const defaultOptions = {
  baseKeyPrefix: "",
  accountKeyPrefix: "user:account:",
  accountByUserIdPrefix: "user:account:by-user-id:",
  emailKeyPrefix: "user:email:",
  sessionKeyPrefix: "user:session:",
  sessionByUserIdKeyPrefix: "user:session:by-user-id:",
  userKeyPrefix: "user:",
  verificationTokenKeyPrefix: "user:token:",
}
```

通常在此场景下修改 `baseKeyPrefix` 就足够了，但对于更自定义的配置，也可以单独修改每个键的前缀。

```ts
import NextAuth from "next-auth"
import { UnstorageAdapter } from "@auth/unstorage-adapter"
import { createStorage } from "unstorage"

const storage = createStorage()

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: UnstorageAdapter(storage, { baseKeyPrefix: "app2:" }),
})
```

#### 使用 `getItemRaw`/`setItemRaw` 替代 `getItem`/`setItem`

如果使用的存储支持 JSON，可以使其使用 `getItemRaw/setItemRaw` 而非 `getItem/setItem`。

此为实验性功能。更多信息请参阅 [unjs/unstorage#142](https://github.com/unjs/unstorage/issues/142)。

通过在适配器工厂函数的第二个参数 `options` 对象中传递 `useItemRaw: true`（默认为 false）可启用此功能。

```ts
export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: UnstorageAdapter(storage, { useItemRaw: true }),
})
```
