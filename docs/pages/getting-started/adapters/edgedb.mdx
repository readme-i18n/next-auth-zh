import { Code } from "@/components/Code"

<img align="right" src="/img/adapters/edgedb.svg" height="64" width="64" />

# EdgeDB 适配器

## 相关资源

- [EdgeDB 文档](https://www.edgedb.com/docs/)

## 配置

### 安装

```bash npm2yarn
npm install edgedb @auth/edgedb-adapter
npm install @edgedb/generate --save-dev
```

请确保已安装 EdgeDB CLI。按照以下说明操作，或阅读 [EdgeDB 快速入门](https://www.edgedb.com/docs/intro/quickstart) 来安装 EdgeDB CLI 并初始化项目

### 环境变量

```sh
AUTH_EDGEDB_DSN="edgedb://edgedb:p4ssw0rd@10.0.0.1"
```

### 配置

<Code>
<Code.Next>

```js filename="./auth.ts"
import NextAuth from "next-auth"
import { EdgeDBAdapter } from "@auth/edgedb-adapter"
import { createClient } from "edgedb"

const client = createClient({ dsn: process.env.AUTH_EDGEDB_DSN })

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: EdgeDBAdapter(client),
  providers: [],
})
```

</Code.Next>
<Code.Qwik>

```ts filename="/src/routes/plugin@auth.ts"
import { QwikAuth$ } from "@auth/qwik"
import { EdgeDBAdapter } from "@auth/edgedb-adapter"
import { createClient } from "edgedb"

const client = createClient({ dsn: import.meta.env.AUTH_EDGEDB_DSN })

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    providers: [],
    adapter: EdgeDBAdapter(client),
  })
)
```

</Code.Qwik>
<Code.Svelte>

```js filename="./auth.ts"
import { SvelteKitAuth } from "@auth/sveltekit"
import { EdgeDBAdapter } from "@auth/edgedb-adapter"
import { createClient } from "edgedb"

const client = createClient({ dsn: process.env.AUTH_EDGEDB_DSN })

export const { handle, signIn, signOut } = SvelteKitAuth({
  adapter: EdgeDBAdapter(client),
  providers: [],
})
```

</Code.Svelte>
<Code.Express>

```ts filename="./src/routes/auth.route.ts"
import { ExpressAuth } from "@auth/express"
import { EdgeDBAdapter } from "@auth/edgedb-adapter"
import { createClient } from "edgedb"

const app = express()

const client = createClient({ dsn: process.env.AUTH_EDGEDB_DSN })

app.set("trust proxy", true)
app.use(
  "/auth/*",
  ExpressAuth({
    providers: [],
    adapter: EdgeDBAdapter(client),
  })
)
```

</Code.Express>
</Code>

### EdgeDB CLI

#### Linux 或 macOS

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.edgedb.com | sh
```

#### Windows 系统

```powershell
iwr https://ps1.edgedb.com -useb | iex
```

通过 `edgedb --version` 命令检查 CLI 是否可用。如果出现 `Command not found` 错误，可能需要打开新的终端窗口才能使 `edgedb` 命令生效。

安装 CLI 后，从应用程序根目录初始化项目。系统会显示一系列提示信息。

```bash
edgedb project init
```

此过程将启动一个 EdgeDB 实例并将其与当前目录进行["链接"](https://www.edgedb.com/docs/cli/edgedb_instance/edgedb_instance_link#edgedb-instance-link)。只要在该目录内，CLI 命令和客户端库就能自动连接到已链接的实例，无需额外配置。

### 数据模型

将 `dbschema/default.esdl` 中自动生成的文件内容替换为以下内容：

```js filename="default.esdl"
module default {
    type User {
        property name -> str;
        required property email -> str {
            constraint exclusive;
        }
        property emailVerified -> datetime;
        property image -> str;
        multi link accounts := .<user[is Account];
        multi link sessions := .<user[is Session];
        property createdAt -> datetime {
            default := datetime_current();
        };
    }

    type Account {
       required property userId := .user.id;
       required property type -> str;
       required property provider -> str;
       required property providerAccountId -> str {
        constraint exclusive;
       };
       property refresh_token -> str;
       property access_token -> str;
       property expires_at -> int64;
       property token_type -> str;
       property scope -> str;
       property id_token -> str;
       property session_state -> str;
       required link user -> User {
            on target delete delete source;
       };
       property createdAt -> datetime {
            default := datetime_current();
        };

       constraint exclusive on ((.provider, .providerAccountId))
    }

    type Session {
        required property sessionToken -> str {
            constraint exclusive;
        }
        required property userId := .user.id;
        required property expires -> datetime;
        required link user -> User {
            on target delete delete source;
        };
        property createdAt -> datetime {
            default := datetime_current();
        };
    }

    type VerificationToken {
        required property identifier -> str;
        required property token -> str {
            constraint exclusive;
        }
        required property expires -> datetime;
        property createdAt -> datetime {
            default := datetime_current();
        };

        constraint exclusive on ((.identifier, .token))
    }
}

# Disable the application of access policies within access policies
# themselves. This behavior will become the default in EdgeDB 3.0.
# See: https://www.edgedb.com/docs/reference/ddl/access_policies#nonrecursive
using future nonrecursive_access_policies;
```

### 迁移

1. 创建迁移

```
edgedb migration create
```

2. 应用迁移

```
edgedb migrate
```

要了解更多关于 [EdgeDB 迁移](https://www.edgedb.com/docs/intro/migrations#generate-a-migration)的信息，请查阅 [迁移文档](https://www.edgedb.com/docs/intro/migrations)。

### 生成

```npm2yarn
npx @edgedb/generate edgeql-js
```

这将生成[查询构建器](https://www.edgedb.com/docs/clients/js/querybuilder)，使您能够以代码优先的方式使用TypeScript编写完全类型化的EdgeQL查询。

```ts
const query = e.select(e.User, () => ({
  id: true,
  email: true,
  emailVerified: true,
  name: true,
  image: true,
  filter_single: { email: "johndoe@example.com" },
}))

return await query.run(client)
```

## 部署指南

### 部署EdgeDB

首先在您选择的云服务提供商上部署EdgeDB实例：

- [AWS](https://www.edgedb.com/docs/guides/deployment/aws_aurora_ecs)
- [Google Cloud](https://www.edgedb.com/docs/guides/deployment/gcp)
- [Azure](https://www.edgedb.com/docs/guides/deployment/azure_flexibleserver)
- [DigitalOcean](https://www.edgedb.com/docs/guides/deployment/digitalocean)
- [Fly.io](https://www.edgedb.com/docs/guides/deployment/fly_io)
- [Docker](https://www.edgedb.com/docs/guides/deployment/docker) (云环境通用)

### 获取实例DSN

DSN也称为连接字符串，其格式为`edgedb://username:password@hostname:port`。具体获取方式取决于您使用的云服务提供商。

### 设置环境变量

```env filename=".env"
AUTH_EDGEDB_DSN=edgedb://johndoe:supersecure@myhost.com:420
```

### 应用迁移

使用DSN对远程实例执行迁移操作。

```bash
edgedb migrate --dsn <your-instance-dsn>
```

### 配置`prebuild`脚本

在您的 `package.json` 中添加以下 `prebuild` 脚本。当托管服务商初始化构建时，将触发此脚本生成查询构建器。`npx @edgedb/generate edgeql-js` 命令会读取 `EDGEDB_DSN` 环境变量的值，连接数据库，并在托管服务商开始构建项目前生成查询构建器。

```diff filename="package.json"
"scripts": {
  "dev": "next dev",
  "build": "next build",
  "start": "next start",
  "lint": "next lint",
+  "prebuild": "npx @edgedb/generate edgeql-js"
},
```
