import { Callout } from "nextra/components"
import { Code } from "@/components/Code"

<img align="right" src="/img/adapters/firebase.svg" height="64" width="64" />

# Firebase 适配器

> 使用 [Firebase Admin SDK](https://firebase.google.com/docs/admin/setup) 和 [Firestore](https://firebase.google.com/docs/firestore)。

## 相关资源

- [Firebase Admin 文档](https://firebase.google.com/docs/admin/setup)

## 配置

### 安装

```bash npm2yarn
npm install @auth/firebase-adapter firebase-admin
```

### 环境变量

```sh
// Auth via Service Account File
GOOGLE_APPLICATION_CREDENTIALS

// Auth via key values
AUTH_FIREBASE_PROJECT_ID
AUTH_FIREBASE_CLIENT_EMAIL
AUTH_FIREBASE_PRIVATE_KEY
```

### 配置

<Code>
<Code.Next>

```ts filename="auth.ts"
import NextAuth from "next-auth"
import { FirestoreAdapter } from "@auth/firebase-adapter"

export const { handlers, auth, signIn, signOut } = NextAuth({
  providers: [],
  adapter: FirestoreAdapter(),
})
```

</Code.Next>
<Code.Qwik>

```ts filename="/src/routes/plugin@auth.ts"
import { QwikAuth$ } from "@auth/qwik"
import { FirestoreAdapter } from "@auth/firebase-adapter"

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    providers: [],
    adapter: FirestoreAdapter(),
  })
)
```

</Code.Qwik>
<Code.Svelte>

```ts filename="src/auth.ts"
import { SvelteKitAuth } from "@auth/sveltekit"
import { FirestoreAdapter } from "@auth/firebase-adapter"

export const { handle, signIn, signOut } = SvelteKitAuth({
  providers: [],
  adapter: FirestoreAdapter(),
})
```

</Code.Svelte>
<Code.Express>

```ts filename="./src/routes/auth.route.ts"
import { ExpressAuth } from "@auth/express"
import { FirestoreAdapter } from "@auth/firebase-adapter"

const app = express()

app.set("trust proxy", true)
app.use(
  "/auth/*",
  ExpressAuth({
    providers: [],
    adapter: FirestoreAdapter(),
  })
)
```

</Code.Express>
</Code>

### 认证

#### 服务账户文件

首先创建一个 Firebase 项目并生成服务账户密钥。访问：`https://console.firebase.google.com/u/0/project/{project-id}/settings/serviceaccounts/adminsdk`（将 `{project-id}` 替换为你的项目 ID）

1. 下载服务账户密钥并保存到项目中（确保将该文件添加到 `.gitignore`！）
2. 将 [`GOOGLE_APPLICATION_CREDENTIALS`](https://cloud.google.com/docs/authentication/application-default-credentials#GAC) 添加到环境变量，并指向服务账户密钥文件
3. 适配器会自动读取该环境变量，用于通过 Firebase Admin SDK 进行认证。你无需向适配器传递任何额外的认证选项

### 服务账户值

1. 将服务账户密钥下载到临时位置（不要提交此文件！）
2. 向项目添加以下环境变量  
   a. `AUTH_FIREBASE_PROJECT_ID`  
   b. `AUTH_FIREBASE_CLIENT_EMAIL`  
   c. `AUTH_FIREBASE_PRIVATE_KEY`

```ts filename="./auth.ts"
import NextAuth from "next-auth"
import { FirestoreAdapter } from "@auth/firebase-adapter"
import { cert } from "firebase-admin/app"

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: FirestoreAdapter({
    credential: cert({
      projectId: process.env.AUTH_FIREBASE_PROJECT_ID,
      clientEmail: process.env.AUTH_FIREBASE_CLIENT_EMAIL,
      privateKey: process.env.AUTH_FIREBASE_PRIVATE_KEY,
    }),
  }),
})
```

### 使用现有 Firestore 实例

如果已存在 Firestore 实例，可以直接将其传递给适配器。

<Callout>在无服务器环境中传递实例时，请注意处理重复的应用初始化问题。</Callout>

<Callout type="info">
  可以使用 `initFirestore` 工具函数安全地初始化应用并获取实例。
</Callout>

```ts filename="./auth.ts"
import NextAuth from "next-auth"
import { FirestoreAdapter } from "@auth/firebase-adapter"
import { firestore } from "lib/firestore"

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: FirestoreAdapter(firestore),
})
```

该工具函数可确保在无服务器环境中不会出现重复的应用初始化问题。
若未传递参数，将使用 `GOOGLE_APPLICATION_CREDENTIALS` 环境变量初始化 Firestore 实例。

```ts filename="lib/firestore.ts"
import { initFirestore } from "@auth/firebase-adapter"
import { cert } from "firebase-admin/app"

export const firestore = initFirestore({
  credential: cert({
    projectId: process.env.FIREBASE_PROJECT_ID,
    clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
    privateKey: process.env.FIREBASE_PRIVATE_KEY,
  }),
})
```
