---
title: WebAuthn
---

import { Steps, Callout } from "nextra/components"

# WebAuthn (通行密钥)

<Callout type="warning">
  WebAuthn/通行密钥提供程序目前处于实验阶段，不建议在生产环境中使用。
</Callout>

WebAuthn 提供程序需要对所有框架集成以及计划支持它的数据库适配器进行修改。因此，目前 WebAuthn 提供程序仅在以下框架集成和数据库适配器中得到支持。更多框架和适配器的支持即将推出。

- `next-auth@5.0.0-beta.8` 或更高版本
- `@auth/prisma-adapter@1.3.0` 或更高版本
- `node@20.0.0` 或更高版本

<Steps>

### 安装 peer 依赖项

```bash npm2yarn
npm install @simplewebauthn/server@9.0.3 @simplewebauthn/browser@9.0.1
```

`@simplewebauthn/browser` peer 依赖项**仅在使用自定义登录页面时需要**。如果使用 Auth.js 默认页面，可以跳过安装该依赖项。

### 执行必要的数据库迁移

以下是 PostgreSQL 的原始 SQL 迁移脚本，如需查看其他数据库的迁移示例或更多细节，请参阅 [`@auth/prisma-adapter` 文档](/getting-started/adapters/prisma) 中更新的 Prisma 模式。

简而言之，Passkeys 提供程序需要一个名为 `Authenticator` 的额外表。

```sql filename="./migration/add-webauthn-authenticator-table.sql"
-- CreateTable
CREATE TABLE "Authenticator" (
    "credentialID" TEXT NOT NULL,
    "userId" TEXT NOT NULL,
    "providerAccountId" TEXT NOT NULL,
    "credentialPublicKey" TEXT NOT NULL,
    "counter" INTEGER NOT NULL,
    "credentialDeviceType" TEXT NOT NULL,
    "credentialBackedUp" BOOLEAN NOT NULL,
    "transports" TEXT,
    PRIMARY KEY ("userId", "credentialID"),
    CONSTRAINT "Authenticator_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);


-- CreateIndex
CREATE UNIQUE INDEX "Authenticator_credentialID_key" ON "Authenticator"("credentialID");
```

### 更新 Auth.js 配置

在配置中添加 `Passkeys` 提供程序，并确保使用兼容的数据库适配器。

```ts filename="./auth.ts"
import Passkey from "next-auth/providers/passkey"
import { PrismaAdapter } from "@auth/prisma-adapter"
import { PrismaClient } from "@prisma/client"

const prisma = new PrismaClient()

export default {
  adapter: PrismaAdapter(prisma),
  providers: [Passkey],
  experimental: { enableWebAuthn: true },
}
```

如果使用 Auth.js 内置页面，配置即告完成！访问 `/signin` 路由应能看到"使用 Passkeys 登录"按钮。

### 自定义页面

如果使用自定义登录页面，可以通过以下代码调用 `next-auth` 的 `signIn` 函数来启动 WebAuthn 注册和登录流程。

<Callout>
  使用 WebAuthn `signIn` 函数时，仍需安装 `@simplewebauth/browser` peer 依赖项。
</Callout>

```ts filename="app/login/page.tsx"
"use client"

import { useSession } from "next-auth/react"
import { signIn } from "next-auth/webauthn"

export default function Login() {
  const { data: session, update, status } = useSession()

  return (
    <div>
      {status === "authenticated" ? (
        <button onClick={() => signIn("passkey", { action: "register" })}>
          注册新 Passkey
        </button>
      ) : status === "unauthenticated" ? (
        <button onClick={() => signIn("passkey")}>使用 Passkey 登录</button>
      ) : null}
    </div>
  )
}
```

</Steps>
