import { Callout } from "nextra/components"
import { Screenshot } from "@/components/Screenshot"
import { Code } from "@/components/Code"

# TypeScript

Auth.js 致力于类型安全，因此采用 TypeScript 编写并保持 100% 类型安全。它提供了自带的类型定义供您在项目中使用。

即使您不使用 TypeScript，像 VS Code 这样的 IDE 也能利用这些类型信息来提供更优的开发体验。在编码过程中，您将获得关于特定对象/函数结构的智能提示，有时还会显示文档链接、示例代码和其他有价值的资源。

## 设计理念

我们选择采用[模块扩充](https://www.typescriptlang.org/docs/handbook/declaration-merging.html#module-augmentation)而非[泛型](https://www.typescriptlang.org/docs/handbook/2/generics.html)作为主要技术方案，以便在您扩展 Auth.js 资源时实现全应用的类型化。

<details>
<summary>
<b>为何不使用<a href="https://www.typescriptlang.org/docs/handbook/2/generics.html">泛型</a>？</b>
</summary>
各子模块共享的接口并不会作为泛型参数传递给 Auth.js 库函数。

当使用这些类型时，函数始终预期返回这些固定格式。若采用泛型方案，可能在某一处覆盖了类型定义而另一处未同步修改，这将导致类型与实际实现不同步。

通过模块扩充技术，您只需定义一次类型，就能确保它们在所有预期位置保持一致性。

</details>

## 模块扩充

Auth.js 库提供了一系列跨子模块和不同 Auth.js 库（例如 `next-auth` 和 `@auth/prisma-adapter` 会依赖 `@auth/core` 中的类型）共享的接口。

典型的接口示例包括 `Session` 或 `User`。您可以使用 TypeScript 的[模块扩充](https://www.typescriptlang.org/docs/handbook/declaration-merging.html#module-augmentation)功能来扩展这些类型，从而在整个 Auth.js 中添加自定义属性，而无需到处传递泛型参数。

我们以扩展 `Session` 接口为例进行说明。

<Code>
<Code.Next>

```ts filename="auth.ts"
import NextAuth, { type DefaultSession } from "next-auth"

declare module "next-auth" {
  /**
   * Returned by `auth`, `useSession`, `getSession` and received as a prop on the `SessionProvider` React Context
   */
  interface Session {
    user: {
      /** The user's postal address. */
      address: string
      /**
       * By default, TypeScript merges new interface properties and overwrites existing ones.
       * In this case, the default session user properties will be overwritten,
       * with the new ones defined above. To keep the default session user properties,
       * you need to add them back into the newly declared interface.
       */
    } & DefaultSession["user"]
  }
}

export const { auth, handlers } = NextAuth({
  callbacks: {
    session({ session, token, user }) {
      // `session.user.address` is now a valid property, and will be type-checked
      // in places like `useSession().data.user` or `auth().user`
      return {
        ...session,
        user: {
          ...session.user,
          address: user.address,
        },
      }
    },
  },
})
```

</Code.Next>
<Code.Qwik>

```ts filename="plugin@auth.ts"
import { DefaultSession, QwikAuth$ } from "@auth/qwik"

declare module "@auth/qwik" {
  /**
   * Returned by the `useSession` hook and the `session` object in the sharedMap
   */
  interface Session {
    user: {
      /** The user's postal address. */
      address: string
      /**
       * By default, TypeScript merges new interface properties and overwrites existing ones.
       * In this case, the default session user properties will be overwritten,
       * with the new ones defined above. To keep the default session user properties,
       * you need to add them back into the newly declared interface.
       */
    } & DefaultSession["user"]
  }
}

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    callbacks: {
      session({ session, token, user }) {
        // `session.user.address` is now a valid property, and will be type-checked
        // in places like `useSession().user` or `sharedMap.get('session').user`
        return {
          ...session,
          user: {
            ...session.user,
            address: user.address,
          },
        }
      },
    },
  })
)
```

</Code.Qwik>
<Code.Svelte>

```ts filename="auth.ts"
import SvelteKitAuth, { type DefaultSession } from "@auth/sveltekit"

declare module "@auth/sveltekit" {
  interface Session {
    user: {
      userId: string
      /**
       * By default, TypeScript merges new interface properties and overwrites existing ones.
       * In this case, the default session user properties will be overwritten,
       * with the new ones defined above. To keep the default session user properties,
       * you need to add them back into the newly declared interface.
       */
    } & DefaultSession["user"]
  }
}

export const { handle } = SvelteKitAuth({
  callbacks: {
    session: async ({ session, token }) => {
      if (token) {
        session.user.userId = token.sub
      }
      // `session.user.userId` is now a valid property, and will be type-checked
      // in places like `useSession().data.user` or `auth().user`
      return session
    },
  },
})
```

</Code.Svelte>
<Code.Express>
```ts filename="auth.ts"
import { ExpressAuthConfig } from "@auth/express";
// Extend the default Session type to include custom properties
declare module "@auth/express" {
  interface Session {
    user: {
      id: string; // Add a custom `id` property to the session user object
    };
  }
}

export const authConfig: ExpressAuthConfig = {
  callbacks: {
    /**
     * The `session` callback is used to customize the session object
     * returned to the client. Here, we add a custom `id` property to
     * the session user object, which is populated from the JWT token.
     *
     * @param session - The current session object.
     * @param token - The JWT token containing user information.
     * @returns The modified session object with the custom `id` property.
     */
    async session({ session, token }) {
      if (token.sub) {
        // Add the `id` property to the session user object
        session.user.id = token.sub; // `token.sub` contains the user ID
      }
      return session;
    },
  },
};
```
</Code.Express>
</Code>

模块扩充不仅限于特定接口。您可以扩充我们定义的任何 `interface`，以下是您可能根据使用场景需要覆盖的一些常见接口。

```ts filename="types.d.ts"
declare module "next-auth" {
  /**
   * The shape of the user object returned in the OAuth providers' `profile` callback,
   * or the second parameter of the `session` callback, when using a database.
   */
  interface User {}
  /**
   * The shape of the account object returned in the OAuth providers' `account` callback,
   * Usually contains information about the provider being used, like OAuth tokens (`access_token`, etc).
   */
  interface Account {}

  /**
   * Returned by `useSession`, `auth`, contains information about the active session.
   */
  interface Session {}
}

// The `JWT` interface can be found in the `next-auth/jwt` submodule
import { JWT } from "next-auth/jwt"

declare module "next-auth/jwt" {
  /** Returned by the `jwt` callback and `auth`, when using JWT sessions */
  interface JWT {
    /** OpenID ID Token */
    idToken?: string
  }
}
```

<Callout type="info">
  模块声明可以添加到项目 `tsconfig.json` 中
  ["include"](https://www.typescriptlang.org/tsconfig#include)
  配置包含的任何文件。
</Callout>

## 相关资源

1. [TypeScript 文档：模块扩充](https://www.typescriptlang.org/docs/handbook/declaration-merging.html#module-augmentation)
2. [DigitalOcean：TypeScript 中的模块扩充](https://www.digitalocean.com/community/tutorials/typescript-module-augmentation)
3. [创建数据库适配器](/guides/creating-a-database-adapter)
