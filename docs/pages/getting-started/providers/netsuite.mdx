import { Callout } from "nextra/components"
import { Code } from "@/components/Code"

<img align="right" src="/img/providers/netsuite.svg" height="64" width="64" />

# NetSuite

<Callout type="warning">将在 `next-auth@5.0.0-beta.18` 版本发布</Callout>

## 相关资源

- [NetSuite - 创建集成记录 (OAuth 2.0)](https://docs.oracle.com/en/cloud/saas/netsuite/ns-online-help/section_157771733782.html#Related-Topics)
- [NetSuite - 授权 OAuth 请求](https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps)
- [NetSuite - 配置 OAuth 角色](https://docs.oracle.com/en/cloud/saas/netsuite/ns-online-help/section_157771510070.html#Set-Up-OAuth-2.0-Roles)
- [了解更多关于 NetSuite OAuth 2.0 的信息](https://docs.oracle.com/en/cloud/saas/netsuite/ns-online-help/chapter_157769826287.html#OAuth-2.0)

## 配置

### 回调 URL

<Code>
  <Code.Next>

```bash
https://example.com/api/auth/callback/netsuite
```

  </Code.Next>
  <Code.Qwik>

```bash
https://example.com/auth/callback/netsuite
```

  </Code.Qwik>
  <Code.Svelte>

```bash
https://example.com/auth/callback/netsuite
```

  </Code.Svelte>
  <Code.Express>

```bash
https://example.com/auth/callback/netsuite
```

  </Code.Express>
</Code>

> NetSuite 不支持 `http://` 回调 URL。在本地测试时，您可以使用 [ngrok](https://ngrok.com) 等服务获取本地 `https` URL。

### 环境变量

```
AUTH_NETSUITE_ID
AUTH_NETSUITE_SECRET
AUTH_NETSUITE_ACCOUNT_ID
```

### 配置

在配置该提供程序之前，您需要确保完成以下设置。

- [创建集成记录](https://docs.oracle.com/en/cloud/saas/netsuite/ns-online-help/section_157771733782.html#procedure_157838925981)
  - 取消勾选 TBA 认证流程复选框。
  - 勾选 OAuth 2.0 认证流程复选框。
  - 将下方的 `Callback URL` 复制粘贴到 `Redirect URI` 字段中。
  - 然后选择需要使用的权限范围：
    - **REST Web Services** (`rest_webservices`) - 访问 REST Web Services。
    - **RESTlets** (`restlets`) - 访问 RESTLets。
    - **SuiteAnalytics Connect** (`suiteanalytics_connect`) - 访问 SuiteAnalytics Connect。
  - 添加需要使用的策略：
    - 应用图标（可选）（用户被要求授予应用访问权限时显示）- 同意屏幕
    - 应用使用条款（可选）- 包含应用使用条款的 PDF 文件 - 同意屏幕
    - 应用隐私政策（可选）- 包含应用隐私政策的 PDF 文件 - 同意屏幕
  - OAuth 2.0 同意策略偏好设置 - 此设置决定用户是**每次**登录时、**首次**登录时还是**永不**被要求授予应用访问权限。
  - **保存**集成记录。
  - 该集成记录将用于生成提供者的 `clientId` 和 `clientSecret`。**保存生成的值以备后用**

### 用户信息 RESTLet 处理器

要使用此提供程序，您需要在 NetSuite 实例中创建一个 userinfo RESTlet。
我们的 `userinfo` URL 需要是一个 suitelet 或 RESTLet URL，用于提供用户信息。最佳做法是首先使用 `N/runtime` 模块获取基本信息。以下是一个 RESTlet 示例。请确保部署并启用"所有角色"的访问权限。

务必部署并使用任何 URI 的**外部** RESTLet URL。

```js
/**
 * @NApiVersion 2.1
 * @NScriptType Restlet
 */
define(["N/runtime"],
 (runtime) => {
/**
 * Defines the function that is executed when a GET request is sent to a RESTlet.
 * @param {Object} requestParams - Parameters from HTTP request URL; parameters passed as an Object (for all supported
 *     content types)
 * @returns {string | Object} HTTP response body; returns a string when request Content-Type is 'text/plain'; returns an
 *     Object when request Content-Type is 'application/json' or 'application/xml'
 * @since 2015.2
 */
  const get = (requestParams) => {
    let userObject = runtime.getCurrentUser();

    try {
      log.debug({ title: "Payload received:", details: requestParams });

      const { id, name, role, location, email, contact } = userObject;

      log.audit({ title: "Current User Ran", details: name });

      let user = {
        id,
        name,
        role,
        location,
        email,
        contact,
      };

      log.debug({ title: "Returning user", details: user });

      return JSON.stringify(user);
    } catch (e) {
      log.error({ title: "Error grabbing current user:", details: e });
    }
  };

  return {
    get,
  };
);
```

以上是返回基本运行时信息的示例。请确保创建一个新的脚本记录和部署记录。保存部署记录时，您将获得 RESTlet 的 URL，我们将使用该 URL 作为 `userinfo` URL。

### 使用示例

<Code>
  <Code.Next>

```ts filename="@auth.ts"
import NextAuth from "next-auth"
import NetSuite from "next-auth/providers/netsuite"

export const { handlers, auth, signIn, signOut } = NextAuth({
  providers: [
    NetSuite({
      clientId: process.env.AUTH_NETSUITE_ID,
      clientSecret: process.env.AUTH_NETSUITE_SECRET,
      issuer: process.env.AUTH_NETSUITE_ACCOUNT_ID, // EX: TSTDRV1234567 or 81555 for prod, and 1234567-SB1 for Sandbox accounts not "_" use "-".
      // Returns the current user using the N/runtime module. This url can be a suitelet or RESTlet (Recommended)
      // Using getCurrentUser(); So we match this schema returned from this RESTlet in the profile callback. (Required)
      userinfo:
        "https://1234567.restlets.api.netsuite.com/app/site/hosting/restlet.nl?script=123&deploy=1",
      // Optional
      prompt: "login", // Required if you want to force the user to login every time.
      scope: "restlets", // Optional defaults to "restlets rest_webservices". Enter the scope(s) you want to use followed by spaces.
    }),
  ],
})
```

  </Code.Next>
  <Code.Qwik>
  
```ts filename="/src/routes/plugin@auth.ts"
import { QwikAuth$ } from "@auth/qwik"
import NetSuite from "@auth/qwik/providers/netsuite"

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    providers: [
      NetSuite({
        clientId: import.meta.env.AUTH_NETSUITE_ID,
        clientSecret: import.meta.env.AUTH_NETSUITE_SECRET,
        issuer: import.meta.env.AUTH_NETSUITE_ACCOUNT_ID, // EX: TSTDRV1234567 or 81555 for prod, and 1234567-SB1 for Sandbox accounts not "_" use "-".
        // Returns the current user using the N/runtime module. This url can be a suitelet or RESTlet (Recommended)
        // Using getCurrentUser(); So we match this schema returned from this RESTlet in the profile callback. (Required)
        userinfo:
          "https://1234567.restlets.api.netsuite.com/app/site/hosting/restlet.nl?script=123&deploy=1",
        // Optional
        prompt: "login", // Required if you want to force the user to login every time.
        scope: "restlets", // Optional defaults to "restlets rest_webservices". Enter the scope(s) you want to use followed by spaces.
      }),
    ],
  })
)
```

  </Code.Qwik>
  <Code.Svelte>

```ts filename="/src/auth.ts"
import { SvelteKitAuth } from "@auth/sveltekit"
import NetSuite from "@auth/sveltekit/providers/netsuite"
import { env } from "$env/dynamic/private"

export const { handle, signIn, signOut } = SvelteKitAuth({
  providers: [
    NetSuite({
      clientId: env.AUTH_NETSUITE_ID,
      clientSecret: env.AUTH_NETSUITE_SECRET,
      issuer: env.AUTH_NETSUITE_ACCOUNT_ID, // EX: TSTDRV1234567 or 81555 for prod, and 1234567-SB1 for Sandbox accounts not "_" use "-".
      // Returns the current user using the N/runtime module. This url can be a suitelet or RESTlet (Recommended)
      // Using getCurrentUser(); So we match this schema returned from this RESTlet in the profile callback. (Required)
      userinfo:
        "https://1234567.restlets.api.netsuite.com/app/site/hosting/restlet.nl?script=123&deploy=1",
      // Optional
      prompt: "login", // Required if you want to force the user to login every time.
      scope: "restlets", // Optional defaults to "restlets rest_webservices". Enter the scope(s) you want to use followed by spaces.
    }),
  ],
})
```

  </Code.Svelte>
  <Code.Express>

```ts filename="/src/app.ts"
import { ExpressAuth } from "@auth/express"
import NetSuite from "@auth/express/providers/netsuite"

app.use(
  "/auth/*",
  ExpressAuth({
    providers: [
      NetSuite({
        clientId: process.env.AUTH_NETSUITE_ID,
        clientSecret: process.env.AUTH_NETSUITE_SECRET,
        issuer: process.env.AUTH_NETSUITE_ACCOUNT_ID, // EX: TSTDRV1234567 or 81555 for prod, and 1234567-SB1 for Sandbox accounts not "_" use "-".
        // Returns the current user using the N/runtime module. This url can be a suitelet or RESTlet (Recommended)
        // Using getCurrentUser(); So we match this schema returned from this RESTlet in the profile callback. (Required)
        userinfo:
          "https://1234567.restlets.api.netsuite.com/app/site/hosting/restlet.nl?script=123&deploy=1",
        // Optional
        prompt: "login", // Required if you want to force the user to login every time.
        scope: "restlets", // Optional defaults to "restlets rest_webservices". Enter the scope(s) you want to use followed by spaces.
      }),
    ],
  })
)
```

  </Code.Express>
</Code>
