import { Callout } from "nextra/components"
import { Code } from "@/components/Code"

<img
  align="right"
  src="/img/providers/azure-devops.svg"
  height="64"
  width="64"
/>

# Azure DevOps 提供商

<Callout type="warning">
  已弃用 -
  虽然仍可使用，但微软已[不再支持](https://learn.microsoft.com/en-us/azure/devops/integrate/get-started/authentication/oauth?view=azure-devops#available-oauth-models)
  Azure DevOps OAuth，并建议改用 [Microsoft Entra
  ID](/getting-started/providers/microsoft-entra-id)。
</Callout>

## 相关资源

- [Azure DevOps 应用文档](https://aex.dev.azure.com)
- [微软文档](https://docs.microsoft.com/en-us) · [Azure DevOps](https://docs.microsoft.com/en-us/azure/devops/) · [使用 OAuth 2.0 授权访问 REST API](https://docs.microsoft.com/en-us/azure/devops/integrate/get-started/authentication/oauth?view=azure-devops])

## 配置

### 回调 URL

<Code>
  <Code.Next>

```bash
https://example.com/api/auth/callback/azure-devops
```

  </Code.Next>
  <Code.Qwik>

```bash
https://example.com/auth/callback/azure-devops
```

  </Code.Qwik>
  <Code.Svelte>

```bash
https://example.com/auth/callback/azure-devops
```

  </Code.Svelte>
</Code>

### 环境变量

在 `.env.local` 中创建以下条目：

```
AZURE_DEVOPS_APP_ID=<copy App ID value here>
AZURE_DEVOPS_CLIENT_SECRET=<copy generated client secret value here>
```

### 注册应用程序

[`https://app.vsaex.visualstudio.com/app/register`](https://app.vsaex.visualstudio.com/app/register)

提供所需信息：

1. 公司名称
2. 应用程序名称
3. 应用程序网站
4. 授权回调 URL
   - 生产环境使用 `https://example.com/api/auth/callback/azure-devops`
   - 开发环境使用 `https://localhost/api/auth/callback/azure-devops`
5. 授权范围
   - 最低要求为 `用户资料（读取）`

点击「创建应用程序」

<Callout type="warning">
- 即使是本地环境也必须使用 HTTPS

- 后续如需修改授权范围，必须删除并重新创建应用

</Callout>

以下数据将用于后续步骤：

- 应用 ID
- 客户端密钥（点击"显示"按钮后获取，忽略其上方的应用密钥条目）
- 已授权范围

### 配置

<Code>
  <Code.Next>

```ts filename="/auth.ts"
import NextAuth from "next-auth"
import AzureDevOps from "next-auth/providers/azure-devops"

export const { handlers, auth, signIn, signOut } = NextAuth({
  providers: [
    AzureDevOps({
      clientId: AUTH_AZURE_DEVOPS_APP_ID,
      clientSecret: AUTH_AZURE_DEVOPS_CLIENT_SECRET,
    }),
  ],
})
```

  </Code.Next>
  <Code.Qwik>
  
```ts filename="/src/routes/plugin@auth.ts"
import { QwikAuth$ } from "@auth/qwik"
import AzureDevOps from "@auth/qwik/providers/azure-devops"

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    providers: [
      AzureDevOps({
        clientId: import.meta.env.AUTH_AZURE_DEVOPS_APP_ID,
        clientSecret: import.meta.env.AUTH_AZURE_DEVOPS_CLIENT_SECRET,
      }),
    ],
  })
)
```

  </Code.Qwik>
  <Code.Svelte>

```ts filename="/src/auth.ts"
import { SvelteKitAuth } from "@auth/sveltekit"
import AzureDevOps from "@auth/sveltekit/providers/azure-devops"

export const { handle, signIn, signOut } = SvelteKitAuth({
  providers: [
    AzureDevOps({
      clientId: AUTH_AZURE_DEVOPS_APP_ID,
      clientSecret: AUTH_AZURE_DEVOPS_CLIENT_SECRET,
    }),
  ],
})
```

  </Code.Svelte>
  <Code.Express>

```ts filename="/src/app.ts"
import { ExpressAuth } from "@auth/express"
import AzureDevOps from "@auth/express/providers/azure-devops"

app.use(
  "/auth/*",
  ExpressAuth({
    providers: [
      AzureDevOps({
        clientId: AUTH_AZURE_DEVOPS_APP_ID,
        clientSecret: AUTH_AZURE_DEVOPS_CLIENT_SECRET,
      }),
    ],
  })
)
```

  </Code.Express>
</Code>

### 刷新令牌轮换

请以[主指南](/guides/refresh-token-rotation)为起点，并注意以下事项：

```ts filename="./auth.ts"
export const { signIn, signOut, auth } = NextAuth({
  callbacks: {
    async jwt({ token, user, account }) {
      // The token has an absolute expiration time
      const accessTokenExpires = account.expires_at * 1000
    },
  },
})

async function refreshAccessToken(token) {
  const response = await fetch(
    "https://app.vssps.visualstudio.com/oauth2/token",
    {
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      method: "POST",
      body: new URLSearchParams({
        client_assertion_type:
          "urn:ietf:params:oauth:client-assertion-type:jwt-bearer",
        client_assertion: AZURE_DEVOPS_CLIENT_SECRET,
        grant_type: "refresh_token",
        assertion: token.refreshToken,
        redirect_uri:
          process.env.NEXTAUTH_URL + "/api/auth/callback/azure-devops",
      }),
    }
  )

  // The refreshed token comes with a relative expiration time
  const accessTokenExpires = Date.now() + newToken.expires_in * 1000
}
```
