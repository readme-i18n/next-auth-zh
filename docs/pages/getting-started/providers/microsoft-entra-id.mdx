import { Callout } from "nextra/components"
import { Code } from "@/components/Code"

<img
  align="right"
  src="/img/providers/microsoft-entra-id.svg"
  height="64"
  width="64"
/>

# Microsoft Entra ID

<Callout>
  微软已将 **Azure AD** 更名为 **Microsoft Entra
  ID**，关于新命名的更多信息可查阅
  [此处](https://learn.microsoft.com/en-us/entra/fundamentals/new-name)。
</Callout>

## 相关资源

- [Microsoft Entra OAuth 文档](https://learn.microsoft.com/en-us/entra/identity-platform/v2-oauth2-auth-code-flow)
- [Microsoft Entra OAuth 应用](https://learn.microsoft.com/en-us/entra/identity-platform/quickstart-register-app)

## 配置

### 回调 URL

<Code>
  <Code.Next>

```bash
https://example.com/api/auth/callback/microsoft-entra-id
```

  </Code.Next>
  <Code.Qwik>

```bash
https://example.com/auth/callback/microsoft-entra-id
```

  </Code.Qwik>
  <Code.Svelte>

```bash
https://example.com/auth/callback/microsoft-entra-id
```

  </Code.Svelte>
  <Code.Express>

```bash
https://example.com/auth/callback/microsoft-entra-id
```

  </Code.Express>
</Code>

### 环境变量

```
AUTH_MICROSOFT_ENTRA_ID_ID
AUTH_MICROSOFT_ENTRA_ID_SECRET
AUTH_MICROSOFT_ENTRA_ID_ISSUER
```

### 注册应用程序

1. 登录 [Microsoft Entra 管理中心](https://entra.microsoft.com/)。

2. 在左侧边栏中，导航至 Identity --> Applications --> App Registrations（应用注册）。

3. 点击 New registration（新建注册）。

4. 为您的应用程序命名。此名称将在用户登录时显示给他们。

5. 选择允许登录的账户类型。`AUTH_MICROSOFT_ENTRA_ID_ISSUER` 变量的值将基于此处选择：

   - **仅单租户** - 仅允许您组织的用户登录。<br />
     `https://login.microsoftonline.com/<Directory (tenant) ID>/v2.0`

   - **多租户** - 允许任何组织的用户登录。<br />
     `https://login.microsoftonline.com/organizations/v2.0`

   - **多租户 + 个人账户** - 允许任何 Microsoft 账户（工作、学校或个人账户）登录。<br />
     `https://login.microsoftonline.com/common/v2.0`

   - **仅个人账户** - 仅允许个人 Microsoft 账户登录。<br />
     `https://login.microsoftonline.com/consumers/v2.0`

6. 将重定向 URI 平台设置为 `web`，并配置应用程序的回调 URI。开发时可设置为本地主机环境（例如 `http://localhost:3000/api/auth/callback/microsoft-entra-id`）。

7. 从应用程序概览页面复制 **Application (client) ID**（应用程序客户端 ID），并粘贴到 `AUTH_MICROSOFT_ENTRA_ID_ID` 变量中。

8. 导航至 Certificates & secrets（证书和密码）并创建新的客户端密钥。

9. 复制密钥值（离开此页面后将不可见），并粘贴到 `AUTH_MICROSOFT_ENTRA_ID_SECRET` 变量中。

### 配置

<Code>
  <Code.Next>

```ts filename="/auth.ts"
import NextAuth from "next-auth"
import MicrosoftEntraID from "next-auth/providers/microsoft-entra-id"

export const { handlers, auth, signIn, signOut } = NextAuth({
  providers: [
    MicrosoftEntraID({
      clientId: process.env.AUTH_MICROSOFT_ENTRA_ID_ID,
      clientSecret: process.env.AUTH_MICROSOFT_ENTRA_ID_SECRET,
      issuer: process.env.AUTH_MICROSOFT_ENTRA_ID_ISSUER,
    }),
  ],
})
```

  </Code.Next>
  <Code.Qwik>
  
```ts filename="/src/routes/plugin@auth.ts"
import { QwikAuth$ } from "@auth/qwik"
import MicrosoftEntraID from "@auth/qwik/providers/microsoft-entra-id"

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    providers: [
      MicrosoftEntraID({
        clientId: import.meta.env.AUTH_MICROSOFT_ENTRA_ID_ID,
        clientSecret: import.meta.env.AUTH_MICROSOFT_ENTRA_ID_SECRET,
        issuer: import.meta.env.AUTH_MICROSOFT_ENTRA_ID_ISSUER,
      }),
    ],
  })
)
```

  </Code.Qwik>
  <Code.Svelte>

```ts filename="/src/auth.ts"
import { SvelteKitAuth } from "@auth/sveltekit"
import MicrosoftEntraID from "@auth/sveltekit/providers/microsoft-entra-id"
import {
  AUTH_MICROSOFT_ENTRA_ID_ID,
  AUTH_MICROSOFT_ENTRA_ID_SECRET,
  AUTH_MICROSOFT_ENTRA_ID_ISSUER,
} from "$env/static/private"

export const { handle, signIn, signOut } = SvelteKitAuth({
  providers: [
    MicrosoftEntraID({
      clientId: AUTH_MICROSOFT_ENTRA_ID_ID,
      clientSecret: AUTH_MICROSOFT_ENTRA_ID_SECRET,
      issuer: AUTH_MICROSOFT_ENTRA_ID_ISSUER,
    }),
  ],
})
```

  </Code.Svelte>
  <Code.Express>

```ts filename="/src/app.ts"
import { ExpressAuth } from "@auth/express"
import MicrosoftEntraID from "@auth/express/providers/microsoft-entra-id"

app.use(
  "/auth/*",
  ExpressAuth({
    providers: [
      MicrosoftEntraID({
        clientId: process.env.AUTH_MICROSOFT_ENTRA_ID_ID,
        clientSecret: process.env.AUTH_MICROSOFT_ENTRA_ID_SECRET,
        issuer: process.env.AUTH_MICROSOFT_ENTRA_ID_ISSUER,
      }),
    ],
  })
)
```

  </Code.Express>
</Code>

```env filename=".env.local"
AUTH_MICROSOFT_ENTRA_ID_ID="<Application (client) ID>"
AUTH_MICROSOFT_ENTRA_ID_SECRET="<Client secret value>"
AUTH_MICROSOFT_ENTRA_ID_ISSUER="https://login.microsoftonline.com/<Directory (tenant) ID>/v2.0"
```

## 注意事项

- 如果未设置 issuer 参数，将默认使用 `https://login.microsoftonline.com/common/v2.0`。

- Microsoft Entra 会以 ArrayBuffer 格式返回个人资料图片，而非直接返回图片 URL。因此我们的提供程序会将其转换为 base64 编码的图片字符串后返回。详见 [Microsoft Graph profilePhoto](https://learn.microsoft.com/en-us/graph/api/profilephoto-get?view=graph-rest-1.0&tabs=http#examples)。默认图片尺寸为 48x48 像素，以避免当会话以 JWT 形式保存时[超出存储限制](https://next-auth.js.org/faq#json-web-tokens)。
