import { Callout } from "nextra/components"
import { Code } from "@/components/Code"

<img align="right" src="/img/providers/loops.svg" height="96" />

# Loops 提供商

## 概述

Loops 提供商通过电子邮件发送包含验证令牌 URL 的"魔法链接"，可用于登录。

在支持 OAuth 服务登录的同时增加邮件登录方式，为用户在无法访问 OAuth 账户时（例如账户被锁定或删除）提供了备用登录途径。

Loops 提供商可以单独使用，也可以与一个或多个 OAuth 提供商配合使用。

## 工作原理

首次登录时，系统会向提供的邮箱地址发送一个**验证令牌**。默认情况下该令牌有效期为 24 小时。若在此期间使用了验证令牌（即点击邮件中的链接），系统将为用户创建账户并完成登录。

如果用户使用*已存在账户*的邮箱地址登录，系统会发送邮件，当用户点击邮件中的链接时即可登录与该邮箱关联的账户。

<Callout type="warning">
  Loops 提供商同时支持 JSON Web Token
  和数据库管理的会话，但**必须配置数据库**才能使用。不使用数据库的情况下无法启用电子邮件登录功能。
</Callout>

## 配置

### 在 Loops 上添加并验证域名

首先，您需要完成 Loops 文档中['从这里开始'](https://loops.so/docs/start-here)部分的所有步骤。主要要求是[设置您的域名记录](https://loops.so/docs/start-here#1-set-up-your-domain-records)。

### 生成 API 密钥

接下来，您需要在 [Loops 控制面板](https://loops.so/api-keys)中生成 API 密钥。可以将此 API 密钥保存为 `AUTH_LOOPS_KEY` 环境变量。

```sh
AUTH_LOOPS_KEY=abc
```

### 在 Loops 创建事务性邮件模板

最简单的方法是使用 [Loops 邮件编辑器](https://loops.so/docs/creating-emails/editor)创建事务性邮件模板。如果您是 Loops 的新用户，可以查阅详细的[使用指南](https://loops.so/docs/transactional/guide)。

<br />

从模板创建流程的最后一页复制 Transactional ID 值，并将其保存为 `AUTH_LOOPS_TRANSACTIONAL_ID` 环境变量。按照这些步骤操作后，您现在应该已经为 Loops 设置好了两个环境变量。

```sh
AUTH_LOOPS_KEY=abc
AUTH_LOOPS_TRANSACTIONAL_ID=def
```

<Callout type="warning">
  创建电子邮件模板时，请确保在模板中包含 `url` 变量。这是将发送给用户的
  URL，允许他们进行登录。
</Callout>

<Code>
<Code.Next>
### Configure AuthJS with the Loops Provider
```ts filename="./auth.ts"
import NextAuth from "next-auth"
import Loops from "next-auth/providers/loops"

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: ..., // database adapter of your choosing
  providers: [
    Loops({
      apiKey: process.env.AUTH_LOOPS_KEY,
      transactionalId: process.env.AUTH_LOOPS_TRANSACTIONAL_ID,
    }),
  ],
})
```

</Code.Next>
<Code.Svelte>
### Configure AuthJS with the Loops Provider
```ts filename="./src/auth.ts"
import { SvelteKitAuth } from "@auth/sveltekit"
import Loops from "@auth/sveltekit/providers/loops"
import { AUTH_LOOPS_KEY, AUTH_LOOPS_TRANSACTIONAL_ID } from "@env/static/private"

export const { handle, signIn, signOut } = SvelteKitAuth({
  adapter: ..., // database adapter of your choosing
  providers: [
    Loops({
      apiKey: AUTH_LOOPS_KEY,
      transactionalId: AUTH_LOOPS_TRANSACTIONAL_ID,
    }),
  ],
})
```

</Code.Svelte>
</Code>
