import { Code } from "@/components/Code"

# 支持企业代理

Auth.js 库使用 `fetch` API 与 OAuth 提供商通信。如果您的组织使用企业代理，可能需要配置 `fetch` API 以使用代理。

## 使用自定义 fetch 函数

您可以通过将自定义 `fetch` 函数作为选项传递给提供程序来使用它。

# 使用 Undici 库

这里我们使用 `undici` 库通过代理服务器发出请求，通过向 `undici` 的 `fetch` 实现传递一个 `dispatcher`。

<Code>
  <Code.Next>

```tsx filename="auth.ts"
import NextAuth, { customFetch } from "next-auth"
import GitHub from "next-auth/providers/github"
import { ProxyAgent, fetch as undici } from "undici"

const dispatcher = new ProxyAgent("my.proxy.server")
function proxy(...args: Parameters<typeof fetch>): ReturnType<typeof fetch> {
  // @ts-expect-error `undici` has a `duplex` option
  return undici(args[0], { ...args[1], dispatcher })
}

export const { handlers, auth } = NextAuth({
  providers: [GitHub({ [customFetch]: proxy })],
})
```

  </Code.Next>
</Code>

# 使用 HttpsProxyAgent

在 Edge 运行时或存在代理限制的环境中，`undici` 库可能无法工作。可以使用更简单的方法，通过向 `fetch` 实现传递 `proxyAgent` 来使用 HttpsProxyAgent。

<Code>
  <Code.Next>

```tsx filename="auth.ts"
import NextAuth, { customFetch } from "next-auth"
import GitHub from "next-auth/providers/github"
const { HttpsProxyAgent } = require("https-proxy-agent")

const proxyAgent = new HttpsProxyAgent("my.proxy.server")
async function proxy(url: string, options: any): Promise<Response> {
  const response = (await fetch(url, {
    ...options,
    agent: proxyAgent,
  })) as unknown as Response
  return response
}

export const { handlers, auth } = NextAuth({
  providers: [GitHub({ [customFetch]: proxy })],
})
```

  </Code.Next>
</Code>

## 相关资源

- [`undici` - 使用本地代理调度器的基础代理请求](https://undici.nodejs.org/#/docs/api/ProxyAgent?id=example-basic-proxy-request-with-local-agent-dispatcher)
