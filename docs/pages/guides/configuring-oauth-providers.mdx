import { Callout, Steps } from "nextra/components"
import { Code } from "@/components/Code"

# 配置 OAuth 提供商

## 覆盖默认提供商配置

对于内置提供商，通常您只需指定客户端ID(client id)和客户端密钥(client secret)，如果是OIDC(OpenID Connect)则还需指定颁发者(issuer)。
我们可以[从环境变量中推断这些值](/guides/environment-variables#oauth-variables)。

如需覆盖任何默认提供商配置选项，您可以在提供商的函数调用中添加它们，这些选项将与我们的[默认配置](https://github.com/nextauthjs/next-auth/tree/main/packages/core/src/providers)进行深度合并。
这意味着您只需覆盖需要变更的部分选项。例如若需调整作用域(scope)，仅需覆盖`authorization.params.scope`而非整个`authorization`选项。

例如，要覆盖提供商默认的`scope`，您可以如下操作：

<Code>
<Code.Next>
```ts filename="./auth.ts"
import NextAuth from "next-auth";
import Auth0 from "next-auth/providers/auth0";

export const { handlers, auth } = NextAuth({
  providers: [
    Auth0({ authorization: { params: { scope: "openid custom_scope" } } }),
  ],
});
```
</Code.Next>
<Code.Qwik>
  
```ts filename="/src/routes/plugin@auth.ts"
import { QwikAuth$ } from "@auth/qwik"
import Auth0 from "@auth/qwik/providers/auth0";

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    providers: [
      Auth0({ authorization: { params: { scope: "openid custom_scope" } } }),
    ],
  })
)
```

</Code.Qwik>
<Code.Svelte>
```ts filename="src/auth.ts"
import { SvelteKitAuth } from "@auth/sveltekit";
import Auth0 from "@auth/sveltekit/providers/auth0";

export const { handle, signIn } = SvelteKitAuth({
  providers: [
    Auth0({ authorization: { params: { scope: "openid custom_scope" } } }),
  ],
});
```

```ts filename="src/hooks.server.ts"
export { handle } from "./auth"
```

</Code.Svelte>
</Code>

另一个例子，默认情况下`profile`回调会返回`name`、`email`和`picture`，但您可能希望从提供商获取更多信息。您返回的内容将用于创建数据库中的用户对象。

<Code>
<Code.Next>
```ts filename="./auth.ts"
import NextAuth from "next-auth";
import Auth0 from "next-auth/providers/auth0";

export const { handlers, auth } = NextAuth({
  providers: [
    Auth0({
      // You can also make calls to external resources if necessary.
      async profile(profile) {
        return {};
      },
    }),
  ],
});
```
</Code.Next>
<Code.Qwik>
  
```ts filename="/src/routes/plugin@auth.ts"
import { QwikAuth$ } from "@auth/qwik"
import Auth0 from "@auth/qwik/providers/auth0";

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    providers: [
      Auth0({
        // You can also make calls to external resources if necessary.
        async profile(profile) {
          return {};
        },
      }),
    ],
  })
)
```

</Code.Qwik>
<Code.Svelte>
```ts filename="src/auth.ts"
import { SvelteKitAuth } from "@auth/sveltekit";
import Auth0 from "@auth/sveltekit/providers/auth0";

export const { handle } = SvelteKitAuth({
  providers: [
    Auth0({
      // You can also make calls to external resources if necessary.
      async profile(profile) {
        return {};
      },
    }),
  ],
});
```

```ts filename="src/hooks.server.ts"
export { handle } from "./auth"
```

</Code.Svelte>
</Code>

## 使用自定义提供商

<Callout>
  在从头创建提供商前，请先查看我们的[内置OAuth提供商](/getting-started/authentication/oauth)。
</Callout>

我们支持任何符合 [OAuth](https://datatracker.ietf.org/doc/html/rfc6749) 或 [OIDC](https://openid.net/specs/openid-connect-core-1_0.html) 规范的提供商。
首先向 [`providers` 列表](/reference/core#providers) 传入一个对象：

<Code>
<Code.Next>
```ts filename="./auth.ts"
import NextAuth from "next-auth";

export const { handlers, auth } = NextAuth({
  providers: [{
    id: "my-provider", // signIn("my-provider") and will be part of the callback URL
    name: "My Provider", // optional, used on the default login page as the button text.
    type: "oidc", // or "oauth" for OAuth 2 providers
    issuer: "https://my.oidc-provider.com", // to infer the .well-known/openid-configuration URL
    clientId: process.env.AUTH_CLIENT_ID, // from the provider's dashboard
    clientSecret: process.env.AUTH_CLIENT_SECRET, // from the provider's dashboard
  }],
});
```
</Code.Next>
<Code.Qwik>
  
```ts filename="/src/routes/plugin@auth.ts"
import { QwikAuth$ } from "@auth/qwik"

export const { onRequest, useSession, useSignIn, useSignOut } = QwikAuth$(
  () => ({
    providers: [{
      id: "my-provider", // signIn("my-provider") and will be part of the callback URL
      name: "My Provider", // optional, used on the default login page as the button text.
      type: "oidc", // or "oauth" for OAuth 2 providers
      issuer: "https://my.oidc-provider.com", // to infer the .well-known/openid-configuration URL
      clientId: import.meta.env.AUTH_CLIENT_ID, // from the provider's dashboard
      clientSecret: import.meta.env.AUTH_CLIENT_SECRET, // from the provider's dashboard
    }],
  })
)
```

</Code.Qwik>
<Code.Svelte>
```ts filename="src/auth.ts"
import { SvelteKitAuth } from "@auth/sveltekit";

export const { handle } = SvelteKitAuth({
  providers: [{
    id: "my-provider", // signIn("my-provider") and will be part of the callback URL
    name: "My Provider", // optional, used on the default login page as the button text.
    type: "oidc", // or "oauth" for OAuth 2 providers
    issuer: "https://my.oidc-provider.com", // to infer the .well-known/openid-configuration URL
    clientId: process.env.AUTH_CLIENT_ID, // from the provider's dashboard
    clientSecret: process.env.AUTH_CLIENT_SECRET, // from the provider's dashboard
  }],
});
```

```ts filename="src/hooks.server.ts"
export { handle } from "./auth"
```

</Code.Svelte>
</Code>

然后在提供商的控制面板中将 [回调 URL](https://www.ietf.org/archive/id/draft-ietf-oauth-v2-1-07.html#name-client-redirection-endpoint) 设置为 `https://app.com/{basePath}/callback/{id}`。

<Callout type="info">
  默认情况下，Next.js 的 `basePath` 是 `/api/auth`，其他所有集成中则为
  `/auth`。详见 [`basePath`](/reference/core#basepath)。
</Callout>

这样就完成了！🎉

## 添加新的内置提供商

如果您认为自定义提供商可能对他人有用，我们鼓励您提交 PR 将其添加到内置列表中。

<Steps>

### 创建提供者文件

在 [`packages/core/src/providers`](https://github.com/nextauthjs/next-auth/tree/main/packages/core/src/providers) 目录下新建一个 `{provider}.ts` 文件。

### 遵循代码规范

参考[内置提供者](https://github.com/nextauthjs/next-auth/tree/main/packages/core/src/providers)的实现方式，确保您的提供者遵循相同的代码规范，例如：

- 使用 TypeScript
- 使用命名默认导出：`export default function YourProvider`
- 导出定义提供者用户信息属性的 TypeScript `interface`
- 添加必要的 JSDoc 注释/文档。例如 [Auth0 提供者](https://github.com/nextauthjs/next-auth/blob/main/packages/core/src/providers/auth0.ts)是 OIDC 的优秀示例，而 [GitHub 提供者](https://github.com/nextauthjs/next-auth/blob/main/packages/core/src/providers/github.ts)则是 OAuth 提供者的范例。
- 添加指向提供者 API 参考/文档的链接，方便他人了解如何配置该提供者

### 在 GitHub 问题下拉菜单中添加您的提供者

将新提供者名称添加到 [`提供者问题模板`](https://github.com/nextauthjs/next-auth/edit/main/.github/ISSUE_TEMPLATE/2_bug_provider.yml) 的 `Provider type` 下拉选项中

### 添加徽标

将徽标文件 `{provider}.svg` 添加到 [`docs/static/img/providers`](https://github.com/nextauthjs/next-auth/tree/main/docs/static/img/providers) 目录。

</Steps>

当 PR 合并后，其他开发者也能通过我们的任何集成发现并使用该提供者。大功告成！🎉
