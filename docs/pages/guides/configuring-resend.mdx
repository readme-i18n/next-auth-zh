import { Callout, Steps, Tabs } from "nextra/components"
import { Screenshot } from "@/components/Screenshot"

# 使用 Resend 实现魔法链接登录

本教程将指导您在 Next.js 应用中配置 Auth.js，实现通过 **Resend** 进行登录。

魔法链接（又称"无密码"）认证是一种通过电子邮件发送包含验证令牌的 URL 来实现的登录方式。用户点击链接后，只要验证令牌仍然有效，就会被重定向到您的 Auth.js 应用并完成登录。

<Callout type="info">
  本教程使用 Resend 作为无密码邮件服务提供商，Next.js 作为框架。请注意，对于任何
  OAuth
  提供商或框架，**配置过程都相同/非常相似**，主要区别在于如何在所选提供商的控制台中注册您的应用。
</Callout>

## 配置 Auth.js

### 安装 Auth.js 和 Next.js

本教程将使用默认的 [Auth.js & Next.js 示例应用](https://github.com/nextauthjs/next-auth-example)。如果您已有现成的 Next.js 应用，同样适用。若没有，请克隆该仓库：

```bash
git clone https://github.com/nextauthjs/next-auth-example.git && cd next-auth-example
```

如果使用示例应用，Auth.js 已预装完成，否则请遵循 [安装指南](/getting-started/installation) 进行操作。

### 创建服务器配置

接下来，我们将创建主 Auth.js 配置文件，其中包含 Auth.js 的必要配置以及动态路由处理器。

```ts filename="./auth.ts"
import NextAuth from "next-auth"
import Resend from "next-auth/providers/resend"

export const { handlers, auth } = NextAuth({
  providers: [Resend],
})
```

```ts filename="app/api/auth/[...nextauth]/route.ts"
export { GET, POST } from "@/auth"
```

由于这是一个[全捕获动态路由](https://nextjs.org/docs/pages/building-your-application/routing/dynamic-routes#catch-all-segments)，它将响应所有相关的 Auth.js API 路由，使您的应用能够通过 [OAuth 2](https://oauth.net/2) 协议与所选 OAuth 提供商进行交互。

### 添加环境变量

如未操作，请按照[安装章节](/getting-started/installation)说明创建 `.env.local` 文件，并添加以下 Resend API 密钥变量。

```bash filename=".env.local" {3}
AUTH_SECRET="changeMe"

AUTH_RESEND_KEY=
```

待我们注册账户和应用后，将从 Resend 开发者门户获取有效密钥填入 `AUTH_RESEND_KEY`。

## 注册应用

要使用 Resend 发送邮件，您需要完成两项操作：

1. 创建 API 密钥
2. 验证域名

### API 密钥

您需在 [Resend](https://resend.com) 注册账户，然后进入主侧边栏的["API 密钥"](https://resend.com/api-keys)页面。点击**"创建 API 密钥"**，我们仅需"发送权限"。

### 域名

按照 [Resend 文档](https://resend.com/docs/dashboard/domains/introduction)完成域名验证，待所有配置完成后返回此处。

接下来，您需要将 `from` 地址更新为已在 Resend 中配置并验证的域名。

```ts
import NextAuth from "next-auth"
import Resend from "next-auth/providers/resend"

export const { handlers, auth } = NextAuth({
  providers: [
    Resend({
      from: "auth@app.company.com",
    }),
  ],
})
```

## 整体配置

现在我们已经获得了所需的 API 密钥，将其粘贴到之前创建的 `.env.local` 文件中。

```bash filename=".env.local" {3}
AUTH_SECRET="changeMe"

AUTH_RESEND_KEY={apiKey}
```

所有准备工作就绪后，现在可以启动本地开发服务器并测试登录流程。

```bash npm2yarn
npm run dev
```

访问 [`http://localhost:3000`](http://localhost:3000)，您应该会看到以下页面：

import AppStart from "../../public/img/oauth-setup/app-start.webp"

<Screenshot src={AppStart} alt="App Start" />

点击 **"登录"**，您将被重定向到默认的 Auth.js 登录页面。您可以[自定义此页面](/guides/pages/signin)以满足需求。接下来，在邮箱输入框中输入您的电子邮件地址并点击 **"使用 Resend 登录"**。

前往您的收件箱，应该会收到来自 Auth.js 应用的邮件，其中包含一个标有"登录"的按钮。点击此按钮后，您将被重定向回本地开发应用并完成登录！

import GitHubAuthSuccess from "../../public/img/oauth-setup/github-auth-success.webp"

<Screenshot src={GitHubAuthSuccess} alt="GitHub Authentication Success" />

如果您成功返回此处，说明一切正常！我们已经完成了完整的无密码认证流程，让用户可以通过无密码魔法链接登录您的应用！

<Callout>
  您可以自定义此邮件内容并修改一些额外的 Resend 参数。更多详情，请查看我们的
  [Resend 提供商](/getting-started/providers/resend)文档页面。
</Callout>

## 部署

使用 Resend 部署您的 Auth.js 应用程序无需进行其他更改。只需确保您已将所需的所有环境变量添加到生产环境中。更多信息请参阅[部署页面](/getting-started/deployment)。
