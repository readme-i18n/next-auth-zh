import { Callout } from "nextra/components"

# 创建数据库适配器

Auth.js 适配器允许您与任何（甚至多个）数据库/后端服务集成，即使我们尚未提供[官方包](https://github.com/nextauthjs/next-auth/tree/main/packages)。（我们欢迎提交新适配器的 PR！请参阅下方的[指南](#official-adapter-guidelines)。）

Auth.js 适配器非常灵活，您可以仅实现所需的方法，并仅创建实际会使用的数据库表/列。

Auth.js 适配器是一个接收 ORM/数据库客户端并返回包含方法（基于 [`Adapter` 接口](/reference/core/adapters#adapter)）的对象，这些方法与数据库交互。同一个数据库适配器将与任何 Auth.js 库兼容。

可选地，您可以在适配器上运行我们的[适配器测试](https://github.com/nextauthjs/next-auth/blob/main/packages/utils/adapter.ts)，以确保其符合 Auth.js 规范。

## 用户管理

Auth.js 区分用户和账户。一个用户可以拥有多个账户。用户首次使用每种提供者类型登录时都会创建一个账户。例如，如果用户使用 Google 登录，然后使用 Facebook 登录，他们将拥有两个账户，每个提供者一个。用户首次登录的提供者也将用于创建用户对象。请参阅 [`profile()` 提供者方法](/reference/core/providers#profile)。

### 方法与模型

<div style={{display: "grid", gridTemplateColumns: "1fr 1fr"}}>
  <span>
    - [`createUser`](/reference/core/adapters#createuser)
    - [`getUser`](/reference/core/adapters#getuser)
    - [`getUserByAccount`](/reference/core/adapters#getuserbyaccount)
    - [`updateUser`](/reference/core/adapters#updateuser)
    - [`linkAccount`](/reference/core/adapters#linkaccount)

    Not yet invoked by Auth.js:
    - [_`deleteUser`_](/reference/core/adapters#deleteuser)
    - [_`unlinkAccount`_](/reference/core/adapters#unlinkaccount)

  </span>
  ```mermaid
  erDiagram
      User ||--|{ Account : ""
      User {
        string id
      }
      Account {
        string userId
        string type
        string provider
        string providerAccountId
      }
  ```
</div>

另请参阅: [用户](/concepts/database-models#user) 和 [账户](/concepts/database-models#account) 模型。

<Callout type="info">
  虽然 Auth.js 并不强制要求，但为了基本显示目的，我们建议在 `User`
  表中添加以下列：`name`、`email`、`image`。您可以通过 [`profile()`
  提供者方法](/reference/core/providers#profile)
  配置这些列。如果不需要保存这些属性，创建一个空的 `profile() {}` 方法即可。
</Callout>

<Callout type="info">
  虽然 Auth.js 不作强制要求，但 `Account`
  表通常会保存从提供者处获取的令牌。您可以通过 [`account()`
  提供者方法](/reference/core/providers#account)
  配置这些列。如果不需要保存令牌，创建一个空的 `account() {}` 方法即可。
</Callout>

## 数据库会话管理

Auth.js 提供两种会话管理方式。了解其优缺点请参阅 [概念：会话策略](/concepts/session-strategies)。

### 方法与模型

<div style={{display: "grid", gridTemplateColumns: "1fr 1fr"}}>
  <span>
    - [`createSession`](/reference/core/adapters#createsession)
    - [`getSessionAndUser`](/reference/core/adapters#getsessionanduser)
    - [`updateSession`](/reference/core/adapters#updatesession)
    - [`deleteSession`](/reference/core/adapters#deletesession)
  </span>
  ```mermaid
  erDiagram
      User ||--|{ Account : ""
      User {
        string id
      }
      User ||--|{ Session : ""
      Session {
        string id
        timestamp expires
        string sessionToken
        string userId
      }
      Account {
        string userId
        string type
        string provider
        string providerAccountId
      }
  ```
</div>

如需使用数据库会话，您需要实现以下方法：

要添加数据库会话管理功能，您需要按以下方式扩展数据库表/列：

另请参阅: [会话](/concepts/database-models#session) 模型。

## 验证令牌

当您需要支持电子邮件/无密码登录时，Auth.js 会使用数据库存储与用户邮箱地址关联的临时验证令牌。

### 方法与模型

<div style={{display: "grid", gridTemplateColumns: "1fr 1fr"}}>
  <span>
    - [`getUserByEmail`](/reference/core/adapters#getuserbyemail)
    - [`createVerificationToken`](/reference/core/adapters#createverificationtoken)
    - [`useVerificationToken`](/reference/core/adapters#useverificationtoken)
  </span>
  ```mermaid
  erDiagram
      User ||--|{ Account : ""
      User {
        string id
        timestamp emailVerified
      }
      Account {
        string userId
        string type
        string provider
        string providerAccountId
      }
      User ||--|{ VerificationToken : ""
      VerificationToken {
        string identifier
        string token
        timestamp expires
      }
  ```
</div>

另请参阅：[验证令牌](/concepts/database-models#verification-token) 模型。

## 官方适配器指南

<Callout type="info">
  完成以下所有步骤后，即可向我们的
  [代码库](https://github.com/nextauthjs/next-auth) 提交 PR。
</Callout>

如果您创建了适配器并希望我们将其作为官方包分发，请确保满足以下要求。可参考这个 [现有适配器](https://github.com/nextauthjs/next-auth/tree/main/packages/adapter-prisma) 了解包结构、必需文件、测试配置等内容。

1. Adapter _必须_ 实现 [`Adapter` 接口](/reference/core/adapters#adapter) 的所有方法
1. [Adapter 测试](https://github.com/nextauthjs/next-auth/blob/main/packages/utils/adapter.ts) _必须_ 包含且 _必须_ 通过。优先使用 Docker 而非服务，以提高 CI 对网络错误的抵抗力，并减少 GitHub Action Secrets 的数量（这也允许我们在 fork PR 中运行这些测试）
1. Adapter _必须_ 遵循以下编码风格

   - 使用 TypeScript 编写
   - 通过 monorepo 的 linting 规则
   - 不包含 polyfills
   - 配置为 ES 模块 (ESM)
   - 通过 JSDoc 注释进行文档化
   - 主模块至少导出一个命名导出（例如 `export function MyAdapter(): Adapter {}`）
   - 集合/表名应遵循底层 ORM/数据库文档/约定的惯例（复数/单数，camelCase/snake_case）

1. 配置 monorepo 以帮助我们维护包

   - 将（最好是 `.svg` 格式的）徽标添加到[此目录](https://github.com/nextauthjs/next-auth/tree/main/docs/public/img/adapters)
   - 将 Adapter 添加到我们的 GitHub 工作流文件[此处](https://github.com/nextauthjs/next-auth/tree/main/.github/workflows/release.yml#L12)和[此处](https://github.com/nextauthjs/next-auth/tree/main/.github/pr-labeler.yml)
   - 如果有生成的文件，确保[`.gitignore` 它们](https://github.com/nextauthjs/next-auth/tree/main/.gitignore#L58)

1. Adapter _必须_ 能够处理来自用户的任何属性

   ORM/数据库客户端可能有自己的数据类型，但 Auth.js 期望这些数据被规范化为普通的 JavaScript 对象以确保一致性。如果你的 ORM/数据库客户端不会自动转换，你需要在从数据库读取/写入时转换这些值。

   你可能会想根据属性名称进行检查并基于此进行转换，但这是不可扩展的（例如：`User` 对象可能有多个 `Date` 属性，而不仅仅是 `emailVerified`）。

   相反，我们建议创建用于转换值的实用函数。以下是一个如何转换日期的示例（如果你的 ORM/数据库客户端使用其他数据类型，请记住也要转换它们，而不仅仅是日期）。它会检查值是否可以解析为日期，如果可以，则将其转换为 `Date` 对象。否则，保留原始值不变。：

```ts
// https://github.com/honeinc/is-iso-date/blob/8831e79b5b5ee615920dcb350a355ffc5cbf7aed/index.js#L5
const isoDateRE =
  /(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))/

const isDate = (val: any): val is ConstructorParameters<typeof Date>[0] =>
  !!(val && isoDateRE.test(val) && !isNaN(Date.parse(val)))

export const format = {
  /** Takes an object that's coming from a database and converts it to plain JavaScript. */
  from<T>(object: Record<string, any> = {}): T {
    const newObject: Record<string, unknown> = {}
    for (const [key, value] of Object.entries(object))
      if (isDate(value)) newObject[key] = new Date(value)
      else newObject[key] = value
    return newObject as T
  },
  /** Takes an object that's coming from Auth.js and prepares it to be written to the database. */
  to<T>(object: Record<string, any>): T {
    const newObject: Record<string, unknown> = {}
    for (const [key, value] of Object.entries(object))
      if (value instanceof Date) newObject[key] = value.toISOString()
      else newObject[key] = value
    return newObject as T
  },
}
```

## TypeScript

你可以利用框架包中自带的类型（例如 `next-auth/adapters`、`@auth/sveltekit/adapters`）。

```ts
import type { Adapter } from "next-auth/adapters"

function MyAdapter(): Adapter {
  return {
    // your adapter methods here
  }
}
```

使用 JavaScript 编写适配器时，你仍然可以通过 JSDoc 获取编辑器提示和自动补全功能。

```js {1}
/** @return { import("next-auth/adapters").Adapter } */
function MyAdapter() {
  return {
    // your adapter methods here
  }
}
```

## 相关资源

- [官方适配器源代码](https://github.com/nextauthjs/next-auth/tree/main/packages)
- [`Adapter` 接口](/reference/core/adapters#adapter)
