# 与第三方后端集成

通过提供商登录时，您可以使用收到的 OAuth 令牌对第三方 API 进行身份验证。这些令牌可用于授权向支持相应提供商的后端发送请求。

例如：

- GitHub 的 `access_token` 将允许您访问 GitHub 的 API。
- 自托管提供商（如 [Keycloak](https://www.keycloak.org)、[`oidc-provider`](https://github.com/panva/node-oidc-provider) 等）可用于授权自定义第三方后端。

## 将令牌存储在会话中

令牌会在 jwt 回调的 `account` 参数中提供。要将它们存储在会话中，可以先将它们附加到令牌上。

```typescript
jwt({ token, trigger, session, account }) {
  if (account?.provider === "my-provider") {
    return { ...token, accessToken: account.access_token }
  }
  // ...
}
```

为了在发起 API 请求时访问令牌，需要使其对 Auth.js 会话可用。

```typescript
async session({ session, token }) {
  session.accessToken = token.accessToken
  return session
}
```

## 使用令牌发起授权 API 请求

OAuth 令牌通常作为 `Authorization: Bearer <>` 标头附加。建议在服务器端附加此标头，例如通过 [路由处理器](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)。

```typescript
export async function handler(request: NextRequest) {
  const session = await auth()
  return await fetch(/*<your-backend-url>/api/authenticated/greeting*/, {
    headers: { "Authorization":  `Bearer ${session?.accessToken}` }
  })
  // ...
}
```

## 配置后端以通过您的提供商授权请求

请查阅您后端框架的文档以了解如何验证传入的访问令牌。  
以下是一个使用 [Keycloak](https://providers.authjs.dev/keycloak) 实例的 Express.js [示例](https://github.com/nextauthjs/authjs-third-party-backend/tree/main/backend-express)。

```javascript
const app = express()
const jwtCheck = jwt({
  secret: jwks.expressJwtSecret({
    cache: true,
    rateLimit: true,
    jwksRequestsPerMinute: 5,
    jwksUri:
      "https://keycloak.authjs.dev/realms/master/protocol/openid-connect/certs",
  }),
  issuer: "https://keycloak.authjs.dev/realms/master",
  algorithms: ["RS256"],
})
app.get("*", jwtCheck, (req, res) => {
  const name = req.auth?.name ?? "unknown name"
  res.json({ greeting: `Hello, ${name}!` })
})
// ...
```

## 相关资源

- 其他后端框架的更多示例可在[此处](https://github.com/nextauthjs/authjs-third-party-backend/tree/main)找到。
- 客户端应用与第三方 API 集成的完整示例可查看 [next-auth-example](https://github.com/nextauthjs/next-auth-example)。
- [Keycloak](https://www.keycloak.org) - 面向现代应用和服务的开源身份与访问管理
- [`oidc-provider`](https://github.com/panva/node-oidc-provider) - Node.js 实现的 OpenID Certified™ OAuth 2.0 授权服务器
