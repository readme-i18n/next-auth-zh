import { Callout } from "nextra/components"

# 扩展会话信息

Auth.js 库默认仅会在会话中暴露用户的有限信息，以避免意外泄露敏感数据。这些基础字段包括 `name`、`email` 和 `image`。

<Callout type="info">
  所有回调函数均为异步方法，因此您也可以从数据库或外部 API 获取额外信息。
</Callout>

常见的使用场景是将用户 ID 添加到会话中。以下根据您使用的会话策略分别展示实现方式。

## 使用 JWT 策略

要获取用户 ID 访问权限，请在 Auth.js 配置中添加以下内容：

```ts filename="auth.ts"
  //  By default, the `id` property does not exist on `token` or `session`. See the [TypeScript](https://authjs.dev/getting-started/typescript) on how to add it.
  callbacks: {
    jwt({ token, user }) {
      if (user) { // User is available during sign-in
        token.id = user.id
      }
      return token
    },
    session({ session, token }) {
      session.user.id = token.id
      return session
    },
  },
}
```

在登录过程中，`jwt` 回调会暴露来自身份提供商的用户资料信息。您可利用此机制将用户 ID 添加到 JWT 令牌中。此后通过 `token.id` 即可在后续 API 调用中访问该用户 ID。
若要在实际会话中暴露用户 ID，您可在 `session` 回调中访问 `token.id` 并将其保存至 `session.user.id`。

现在调用 `auth()` 或 `useSession()` 时即可访问用户 ID。

## 使用数据库策略

若采用数据库会话策略，可通过修改 `session` 回调来添加用户 ID：

```ts filename="auth.ts"
  //  By default, the `id` property does not exist on `session`. See the [TypeScript](https://authjs.dev/getting-started/typescript) on how to add it.
  callbacks: {
    session({ session, user }) {
      session.user.id = user.id
      return session
    },
  }
}
```

这会将用户的 id 添加到 session 对象中。请注意，在这种情况下，我们从 `user` 对象而非 `token` 中获取 id。
使用数据库会话策略时，`user` 对象来自数据库，此时不存在 `token`。

现在调用 `auth()` 或 `useSession()` 时将能访问用户的 id。

<Callout type="warning">
  会话对象不会在服务端持久化，即使使用数据库会话时也是如此——只有会话令牌(id)、用户信息和过期时间等数据会存储在会话表中。如需在服务端持久化会话数据，必须将其保存在其他地方。您可以在
  `session()` 回调中连接数据库来检索这些信息。
</Callout>

## 使用提供者函数

我们可以通过几种方式扩展默认会话数据，其中之一是使用 `authorize` 和 `profile` 函数。这些函数允许我们返回包含所需属性的用户对象。然后我们可以基于这些信息创建逻辑，在数据库或外部 API 中进行查询。

```ts
import Github from "next-auth/providers/github"
import Credentials from "next-auth/providers/credentials"
import type { Provider } from "next-auth/providers"

const providers: Provider[] = [
  Google({
    clientId: process.env.AUTH_GOOGLE_ID,
    clientSecret: process.env.AUTH_GOOGLE_SECRET,
    async profile(profile) {
      return { ...profile }
    },
  }),
  Credentials({
    async authorize(credentials) {
      return { ...credentials }
    },
  }),
]
```

## 相关资源

- [概念. 会话策略](/concepts/session-strategies)
- [TypeScript](/getting-started/typescript)
